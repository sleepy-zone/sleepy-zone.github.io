<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">7 篇博文 含有标签「Cline」 | 😴 Sleepy Zone</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sleepy-zone.github.io/blog/tags/cline"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="7 篇博文 含有标签「Cline」 | 😴 Sleepy Zone"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://sleepy-zone.github.io/blog/tags/cline"><link data-rh="true" rel="alternate" href="https://sleepy-zone.github.io/blog/tags/cline" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://sleepy-zone.github.io/blog/tags/cline" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="😴 Sleepy Zone RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="😴 Sleepy Zone Atom Feed">





<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap">
<script>!function(t,e,n,a,c,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(a)).async=1,r.src="https://www.clarity.ms/tag/r1wmvdsf4a",(s=e.getElementsByTagName(a)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/assets/css/styles.5d8c36ea.css">
<script src="/assets/js/runtime~main.8b88daf5.js" defer="defer"></script>
<script src="/assets/js/main.9d4e797a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Sleepy Zone Site Logo" class="themedComponent__dKv themedComponent--light_rzkv"><img src="/img/logo.svg" alt="Sleepy Zone Site Logo" class="themedComponent__dKv themedComponent--dark_mMAk"></div><b class="navbar__title text--truncate">Sleepy Zone</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">🔥博客</a><a class="navbar__item navbar__link" href="/thoughts">💡想法</a><a class="navbar__item navbar__link" href="/weekly/2025-04-23">📚不周刊</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-23-cline-source-code-3-engine.md">Cline 源码浅析 - 递归执行引擎</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-20-why-human-intent-matters-more-as-ai-capabilities-grow.md">为什么随着 AI 能力的提升，人类意图变得更加重要</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-16-what-makes-a-coding-agent.md">什么是 Coding Agent?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-13-cline-source-code-prompt.md">Cline 源码浅析 - Prompt 设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-10-cline-source-code-mcp.md">Cline 源码浅析 - MCP 调用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-07-cline-source-code-1.md">Cline 源码浅析 - 从输入到输出</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-05-30-cline-rule.md">现在开始使用 Cline Rules</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-30-ts-agent-mastra.md">Mastra  - TypeScript AI Agent 框架</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-30-deepwiki.md">DeepWiki - 阅读开源代码的神器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-24-google-promtps-2.md">谷歌提示词工程 - 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-23-google-promtps.md">谷歌提示词工程 - 模型原理和提示词技术</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-21-old-fe-1.md">盘点前端还在更新的老项目</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-14-github-no-vistit.md">从 Github 不能访问想到的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-10-what-is-agent.md">什么是 Agent</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-07-deepsite.md">DeepSite：基于 DeepSeek 的生码应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-06-recent-ai-1.md">最近几件关于 AI 的事情</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-28-mcp.md">MCP - AI 和真实世界的桥梁</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-26-dev-mcp-server.md">动手开发一个 MCP Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-21-woocs">woocs，基于 doocs/md 的微信 Markdown 编辑器桌面应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-20-vibe-coding">聊聊 vibe coding</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-19-doocs-md">【开源推荐】高度简洁的微信 Markdown 编辑器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-17-ai-fomo">AI 浪潮下的 FOMO 情绪</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-10-D2">D2 终端技术大会之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-02-25-2025-ai-first">2025 年或许是中国的 AI 元年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-02-19-we-are-destroying-software">【好文推荐】我们正在摧毁软件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ai-replace-fe">AI 可以取代前端吗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/my-2024">迟来的 2024 总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/antd-meetup">Ant Design Meetup 之行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sketch-plugin-upload">Sketch 插件实现图层导出图片并上传</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ui-diff-in-out">国内外组件库的一些差异</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/thinking-recently">对近期一些事情的看法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/shijing">我读了读诗经</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gradient-in-fe">聊聊前端里的渐变</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/fabritor-2024-1">fabritor @ 2024 的一些更新</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023-summary">2023 总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>7 篇博文 含有标签「Cline」</h1><a href="/blog/tags">查看所有标签</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-23-cline-source-code-3-engine.md">Cline 源码浅析 - 递归执行引擎</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-23T00:00:00.000Z">2025年6月23日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img13@main/2025/06/13/1749821751724-de0cc087-4ad2-40a5-bd9e-d9918cae3ea9.png" alt="" class="img_ev3q"></p>
<p>前面我们聊了 Cline <a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">从输入到输出的流程</a>、<a href="https://mp.weixin.qq.com/s/_sU1KTFtV2eoURq0yKaabw" target="_blank" rel="noopener noreferrer">MCP 的调用</a>以及<a href="https://mp.weixin.qq.com/s/pdznzYiS6oUT1epOuBLX3g" target="_blank" rel="noopener noreferrer">Prompt 设计</a>，这篇文章，我们再回过头看一下 Cline 内很重要的一部分 - <strong>递归执行引擎</strong>。</p>
<p>如果你用过 Cline，你会发现一次模型的交互并不会完成任务（聊天界面会多次展示 <code>API Request...</code>），而是需要多次和模型多轮交互，每次交互都会带上之前的结果（用户反馈、工具调用结果），直到模型确认任务完成，才会结束。这就是<strong>递归执行引擎</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prompt-设计">Prompt 设计<a href="#prompt-设计" class="hash-link" aria-label="Prompt 设计的直接链接" title="Prompt 设计的直接链接">​</a></h3>
<p>我们还是先来看下 Cline 的 Prompt 设计，如何保证模型有条不紊的执行的每次循环。</p>
<p>这部分内容在 System Prompt 内，<code>src/core/prompts/system.ts</code>。</p>
<p>首先 Cline 对模型强调了工具的使用规则：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">您可以访问一组工具，这些工具会在用户批准后执行。您每次消息中只能使用一个工具，并将在用户的回复中收到该工具使用的执行结果。您会逐步使用工具来完成给定任务，每次工具的使用都会基于前一个工具使用的结果进行决策。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>You have access to a set of tools that are executed upon the user&#x27;s approval. You can use one tool per message, and will receive the result of that tool use in the user&#x27;s response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.</p>
</blockquote>
<ol>
<li>工具需要用户批准进行</li>
<li>每次消息只能使用一个工具</li>
<li>根据用户反馈，逐步使用工具完成任务</li>
</ol>
<p>对于复杂任务，这就保证了模型不必一次性完成任务，而是可以在多轮会话中使用多种工具共同协作完成任务。</p>
<p>那模型在任务完成后如何告知我们呢？这就是 <code>attempt_completion</code> 工具的作用了，Prompt 如下：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> 尝试完成  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">描述：每次使用工具后，用户会回复该工具的执行结果，即是否成功以及失败的原因。一旦您收到了工具使用的执行结果，并可以确认任务已经完成，请使用此工具向用户展示您的工作成果。您可以选择性地提供一个 CLI 命令来展示您的工作成果。如果用户对结果不满意并给出反馈，您可以根据反馈进行改进并再次尝试。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">重要提示：在确认用户之前的工具使用都已成功之前，</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不能</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">使用此工具。否则会导致代码损坏和系统故障。在使用此工具之前，您必须在 </span><span class="token code-snippet code keyword" style="color:#00009f">`\&lt;thinking\&gt;\&lt;\/thinking\&gt;`</span><span class="token plain"> 标签中自问：是否已从用户那里确认所有先前的工具使用都是成功的？如果不是，则</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">使用此工具。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">参数：  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">result</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">（必填）：任务的结果。请以最终形式表述这个结果，不需要用户进一步输入。不要以问题或提供进一步帮助的提议结尾。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">command</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">（可选）：一条 CLI 命令，用于向用户实时演示结果。例如，使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`open index.html`</span><span class="token plain"> 来显示创建的 HTML 网站，或者使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`open localhost:3000`</span><span class="token plain"> 来显示本地运行的开发服务器。但</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">使用像 </span><span class="token code-snippet code keyword" style="color:#00009f">`echo`</span><span class="token plain"> 或 </span><span class="token code-snippet code keyword" style="color:#00009f">`cat`</span><span class="token plain"> 这类只打印文本的命令。该命令应适用于当前操作系统，并确保格式正确，不包含任何有害指令。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">attempt_completion\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">result\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your final result description here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;\/result\&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">command\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Command to demonstrate result (optional)\&lt;\/command\&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;\/attempt_completion\&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>模型确认任务完成后，调用 <code>attempt_completion</code> 这个工具，根据我们之前聊过的，Cline 会从模型的消息中解析工具的使用，在解析到模型消息中包含 <code>attempt_completion</code> 这个工具的使用时，我们可以确认任务完成了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task">Task<a href="#task" class="hash-link" aria-label="Task的直接链接" title="Task的直接链接">​</a></h3>
<p>后续就是 Cline 对模型消息的处理和递归的逻辑了，这部分代码在 <code>src/core/task/index.ts</code> 文件下。</p>
<p><code>recursivelyMakeClineRequests</code>，看名字就知道是在做递归调用，主要是做一些 User Prompts 的拼装、聊天消息的组装，处理模型请求的流式消息等，只要模型没明确调用 <code>attempt_completion</code> ，就一直会调用自身。</p>
<p>关于 <code>attempt_completion</code> 工具的真实调用还是在 <code>presentAssistantMessage</code> 方法内，这里就不展开了。</p>
<p>下面是一个输出示例，使用 Cline 将截图转为 React 代码，任务完成后，模型输出如下：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">thinking\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Now I&#x27;ll complete the task by summarizing what I&#x27;ve done and presenting the final result.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;\/thinking\&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">attempt_completion\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">result\</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I&#x27;ve successfully converted the provided module screenshot into a React component structure following all the specified requirements. Here&#x27;s what I&#x27;ve created:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The implementation closely follows the visual design from the provided screenshot, with proper styling, layout, and component structure.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;\/result\&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\&lt;\/attempt_completion\&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3>
<p>再次感叹，模型的如何通过 Prompt 和 Tool 让模型发挥出更大价值才是 Agent 最重要的事情。</p>
<p>至此，Cline 源码浅析系列关于模型相关的到此为止了，后面有计划继续探索下 Cline 工程相关的内容，比如检查点、VSCode 插件这些内容。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-20-why-human-intent-matters-more-as-ai-capabilities-grow.md">为什么随着 AI 能力的提升，人类意图变得更加重要</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-20T00:00:00.000Z">2025年6月20日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/19/1750328660936-1ea0145a-8060-45e6-8641-5e2879d98704.png" alt="" class="img_ev3q"></p>
<p>发烧两天，终于恢复，继续更新。</p>
<p>我发现 Cline 的官方博客真的是宝藏，虽然其实很多博客都是在宣传自身或者自身的一个 feature，但确实有很多很深刻又很有启发的观点，忍不住想分享给大家。比如今天这篇：<a href="https://cline.bot/blog/why-human-intent-matters-more-as-ai-capabilities-grow" target="_blank" rel="noopener noreferrer"><strong>为什么随着 AI 能力的提升，人类意图变得更加重要。</strong></a>配合前文<a href="https://mp.weixin.qq.com/s/pdznzYiS6oUT1epOuBLX3g" target="_blank" rel="noopener noreferrer">
Cline 源码浅析 - Prompt 设计
</a>食用更加。</p>
<hr>
<p>还记得当 AI 编码只是简单的自动补全吗？那时，人类完成了大部分工作：浏览代码库、寻找正确的文件、定位要编辑的位置、开始输入，然后 AI 才能提供一些建议。人类是主导者，而 AI 只是辅助。</p>
<p>如今的智能 AI 能够搜  索代码库、读取文件、编写完整模块、重构系统，并在多个文件中进行复杂的变更。借助像 Cline 这样的工具，AI 几乎接管了整个编码过程。这就产生了一个有趣的问题：如果 AI 几乎能做所有事情，人类还能做什么？</p>
<p>答案其实很简单：<strong>意图</strong>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="最后一段路是最重要的">最后一段路是最重要的<a href="#最后一段路是最重要的" class="hash-link" aria-label="最后一段路是最重要的的直接链接" title="最后一段路是最重要的的直接链接">​</a></h2>
<p>随着 AI 能力的增强，人类的角色并没有减少，而是发生了转变。当 AI 能够处理编码的细节时，我们需要思考：<em>我们在构建什么，以及为什么要构建它？</em></p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/06/19/1750328832364-a318ee62-8982-441b-99b0-04f0d65594f3.png" alt="" class="img_ev3q"></p>
<p>可以将这过程视为一张工作量的饼图。在自动补全时代：</p>
<ul>
<li>人类工作量： 95%（导航、规划、输入、调试）</li>
<li>AI 工作量：5%（提供建议）</li>
</ul>
<p>在智能 AI 时代：</p>
<ul>
<li>AI 工作量：95%（搜索、阅读、写作、重构）</li>
<li>人类工作量：5%（意图）</li>
</ul>
<p>而这 5% 就是<strong>决定性因素</strong>。它决定了 AI 是完美地构建错误的东西，还是构建完全符合需求的东西。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么我们创建了计划-行动模式">为什么我们创建了计划-行动模式<a href="#为什么我们创建了计划-行动模式" class="hash-link" aria-label="为什么我们创建了计划-行动模式的直接链接" title="为什么我们创建了计划-行动模式的直接链接">​</a></h2>
<p>问题在于：AI 充满热情。一旦赋予它读写文件的工具，它就会立即开始编码。这就像  一个才华横溢的开发者在完全理解需求之前就开始动手。</p>
<p>这种急切并不是缺陷，而是这些模型工作的特性。它们被设计为提供帮助、采取行动、解决问题。但如果没有明确的意图，行动可能会走偏。</p>
<p>计划-行动模式不是为了给 AI 设置不同的“模式”，而是为了认识到有效合作的自然阶段。在计划阶段，我们为相互理解创造了一个专门的空间。我们让 AI 尽可能地关注人类的意图。不是因为 AI 能力不足，而是因为意图是唯一无法自动化的东西。</p>
<p>接下来是行动阶段，我们将其放手。AI 的能力不变，但现在优化为不间断的执行。这是我们互动方式的模式转变，而不是性格的变化。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="反角色哲学-为何计划-行动不是模式">反角色哲学 (为何计划-行动不是“模式”)<a href="#反角色哲学-为何计划-行动不是模式" class="hash-link" aria-label="反角色哲学 (为何计划-行动不是“模式”)的直接链接" title="反角色哲学 (为何计划-行动不是“模式”)的直接链接">​</a></h2>
<p>你可能见过一些编码助手，拥有专门的“智能体”：比如调试器、架构师和代码审阅者。我们刻意避开这种方法，原因如下图：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img3@main/2025/06/19/1750340787740-6044e41d-6a0e-4eee-871c-3d3cfadbf460.png" alt="我们设计 Cline 是为了展现模型的潜力，而不是按照我们的需求来操控它们。" class="img_ev3q"></p>
<blockquote>
<p>图中的英文翻译：第二个要从这个痛苦的教训中学到的要点是：心灵的实际内容是极其复杂的，无法挽回的；我们应该停止尝试找到简单的方法来思考心灵的内容，比如思考空间、物体、多个智能体或对称性的简单方法。所有这些都是任意的、本质上复杂的外界的一部分。由 于它们的复杂性是无穷的，因此不应内置其中；相反，<strong>我们应该仅构建能够发现和捕捉这种任意复杂性的元方法。</strong></p>
</blockquote>
<p>Richard Sutton 在 AI 研究中的<a href="http://www.incompleteideas.net/IncIdeas/BitterLesson.html?ref=cline.ghost.io" target="_blank" rel="noopener noreferrer">“苦涩教训”</a>指出，利用计算的通用方法往往优于专业化的人工设计解决方案。当深蓝击败 Kasparov 时，它并没有使用大师级策略，而是依靠蛮力搜索。当 AlphaGo 征服围棋时，它并没有遵循古老的智慧，而是使用通用学习算法。</p>
<p>现代语言模型，例如 Claude Sonnet 4 和 Geminin 2.5 Pro，经过完整的编码过程训练，已经见识过数百万个架构决策、调试会话和代码审阅的案例。人工角色的创建会限制它们自然的能力。</p>
<p>这点很关键：<strong>计划和行动不是不同 AI 个性或能力的“模式”</strong>。我们没有在“计划 AI”和“编码 AI”之间切换。它始终是同一个 AI，能力不变。</p>
<p>变化的是交互模式。在计划阶段，我们优化意图收集；AI 会提问，探索上下文，确保理解。在行动阶段，我们优化执行；AI 不间断地发挥其全部能力。这是关于识别人类与 AI 合作的自然节奏，而不是限定 AI 的角色。</p>
<p>可以将其类比于对话与专注工作。你不会认为开发者在需求会议与编码时有不同的“模式”。他们是同一个人，只是在不同的工作阶段中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="不要打扰-ai">不要打扰 AI<a href="#不要打扰-ai" class="hash-link" aria-label="不要打扰 AI的直接链接" title="不要打扰 AI的直接链接">​</a></h2>
<p>我们发现一个有趣的现象：大语言模型是出色的<a href="https://x.com/cline/status/19107658728280802930?ref=cline.ghost.io" target="_blank" rel="noopener noreferrer">叙述者</a>。它们是为构建连贯故事而设计的预测文本引擎：先发生这个，然后是那个，再然后是另一个。</p>
<p>如果你在 AI 执行任务时中途打断它来纠正方向，就会破坏这种叙述的流畅性。模型需要调整你的干预与之前的路径，通常会导致混乱或不理想的结果。</p>
<p>斯坦福大学的<a href="https://cs.stanford.edu/~nfliu/papers/lost-in-the-middle.arxiv2023.pdf?ref=cline.ghost.io" target="_blank" rel="noopener noreferrer">“迷失在中间”</a>研究 (Liu et al., 2023) 表明，当处理被打断的上下文时，大语言模型的性能会显著下降。研究发现，当相关信息出现在长上下文的中间而不是开始时，模型的准确率下降了近 20%。重新开始，虽然看似低效，但通常效果更好，因为模型能够从清晰的意图构建完整的叙述，而不需要在受损的中间上下文信息中挣扎。</p>
<p>这就是为什么重新开始并提供更清晰的指令通常比纠正方向更有效。保存当前状态，让 AI 继续工作，然后接受结果或者重新开始，而不是纠结于修正。</p>
<p>随着推理成本下降，我们甚至可以同时进行多次尝试，并选择最佳结果，就像拉动老虎机一样，每次拉杆的成功概率都是独立的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="让-ai-自主运作">让 AI 自主运作<a href="#让-ai-自主运作" class="hash-link" aria-label="让 AI 自主运作的直接链接" title="让 AI 自主运作的直接链接">​</a></h2>
<p>在计划阶段确定了你的意图后，接下来的原则同样重要：让 AI 自由发挥。</p>
<p>这与我们的反角色哲学直接相关。我们不将 AI 限制为“调试器”或“架构师”等特定角色，同样，我们也不会在执行过程中限制它。行动阶段的重点是让模型充分发挥其所有能力：架构决策、调试、重构、优化，作为一个整体智能体。</p>
<p>我们注意到，最新的 Claude 4 模型在自动批准模式下表现优异 。每次中断都会打断其叙述流程。最有效的情况是 AI 能够不受干扰地进行写作。</p>
<blockquote>
<p>需要注意的是，模型的最佳表现来自不受干扰的构建。然而，结果可能并不总是与你的意图完全一致。因此，如果你从事复杂的工程工作，我们建议你仍然保持参与，更重要的是，详细制定你的计划。</p>
</blockquote>
<p>这可能看起来有些违反直觉。难道我们不需要控制、监督和干预的能力吗？</p>
<p>是的，但不需要实时进行。这就是我们构建以下功能的原因：</p>
<ul>
<li>检查点（Checkpoints）：保存状态，随时可以返回。</li>
<li>全面可见性（Full visibility）：了解 AI 的全部操作。</li>
<li>撤销功能（Undo capabilities）：撤销任何更改。</li>
<li>安全边界（Safety boundaries）：定义 AI 能触及和不能触及的范围。</li>
</ul>
<p>关键在于时机。先收集需求，共享意图，设定边界，然后让 AI 工作。之后再进行审查和迭代，而不是实时进行。</p>
<hr>
<p>编码的未来不在于人类与 AI 竞争或通过不断细化专业领域来保持重要性。而在于人类发挥独特的作用：提供意图、意义和目标，而由 AI 来执行具体操作。</p>
<p>这不仅不是一个减弱的角色，而是所有角色中最为重要的。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-16-what-makes-a-coding-agent.md">什么是 Coding Agent?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-16T00:00:00.000Z">2025年6月16日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img13@main/2025/06/13/1749821751724-de0cc087-4ad2-40a5-bd9e-d9918cae3ea9.png" alt="" class="img_ev3q"></p>
<p>本文翻译自 Cline 博客 <a href="https://cline.bot/blog/what-makes-a-coding-agent" target="_blank" rel="noopener noreferrer">What Makes a Coding Agent?</a>。</p>
<p>在我写完<a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">Cline 源码浅析 - 从输入到输出</a>后，我就看到了这篇博客，整个博客的内容和我结尾的观点不谋而合。</p>
<hr>
<p>当开发者首次接触到 Cline 时，他们常常称之为自己的“通用人工智能 (AGI) 时刻”——那一瞬间，他们意识到 AI 已经从一个简单的建议工具发展成为真正的编码伙伴。那么，究竟是什么让一个真正的编码 AI 智能体与众多 AI 驱动的开发工具有所不同呢？答案在于理解“智能体”这个词的确切含义。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="agent-定义">Agent 定义<a href="#agent-定义" class="hash-link" aria-label="Agent 定义的直接链接" title="Agent 定义的直接链接">​</a></h3>
<p>OpenAI 将智能体定义为“一个能够独立为你完成任务的系统”。Anthropic 则更进一步，描述智能体为“一个系统，其中的大语言模型 (LLM) 能够动态地指挥自身的流程和工具使用，掌控任务的完成方式”。虽然各家公司可能在细节上有所不同，但在基本架构上达成了共识：智能体由三个重要部分组成：<strong>(1) 模型，(2) 工具，和 (3) 指令</strong>。</p>
<p>这种区别比你想象的更为重要。以 ChatGPT 为例。虽然 ChatGPT 技术先进，但它并不是真正的 AI 智能体；它是为聊天应用精心调整的模型。它可以根据你的提示进行回应，但无法独立组织复杂的工作流程或自主决定如何完成多步骤任务。</p>
<p>相比之下，Cline 被构建为一个真正的 AI 智能体，因为它通过三个重要的组成部分自主生成代码。接下来，我们来探讨每个组件的工作原理，以及为什么这种架构能够实现本质上不同的能力。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自主编码的三大基础">自主编码的三大基础<a href="#自主编码的三大基础" class="hash-link" aria-label="自主编码的三大基础的直接链接" title="自主编码的三大基础的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-模型大脑">1. 模型：大脑<a href="#1-模型大脑" class="hash-link" aria-label="1. 模型：大脑的直接链接" title="1. 模型：大脑的直接链接">​</a></h4>
<p><strong>模型</strong>是智能体的核心决策者，可以说是“大脑”。当你配置 Cline 时，其实是在选择哪个 AI 模型来驱动你的编码伙伴。Cline 支持多个提供商，包括 Anthropic、OpenAI 和 Google，并提供具体的模型，比如 Claude 3.5 Sonnet、GPT-4.1 或 Gemini 2.5 Pro。</p>
<p>这种不依赖特定模型的方法不仅仅是关于选择，更是关于赋予使用者更多的能力。许多竞争对手会将你锁定在特定模型上，或者施加限制来保护他们的推理利润，而 Cline 则让你可以完全使用所选模型的全部功能。无论你需要强大的前沿模型来进行复杂的架构决策，还是选择像 DeepSeek-V3-0324 这样的经济型模型来完成日常任务，Cline 都为你提供了无障碍的途径。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-工具双手">2. 工具：双手<a href="#2-工具双手" class="hash-link" aria-label="2. 工具：双手的直接链接" title="2. 工具：双手的直接链接">​</a></h4>
<p><strong>工具</strong>是 AI 智能体执行任务时使用的外部功能，可以把它们理解为动词，比如“搜索”、“编辑”和“阅读”。Cline 提供了一个全面的工具包，其中包括文件操作、终端命令、浏览器自动化，以及通过模型上下文协议 (MCP) 与外部服务的整合。</p>
<p>这是自主性的重要体现。传统软件通常按照预设的操作步骤执行，而 Cline 的智能体架构则让模型自主决定使用哪些工具以及使用的时机。面对复杂的编码任务，Cline 可以自主选择是先探索代码库、阅读文档、运行测试，还是直接开始实现。这种动态决策过程就是人们所说的智能体“自主性”的真正含义。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-指令指引">3. 指令：指引<a href="#3-指令指引" class="hash-link" aria-label="3. 指令：指引的直接链接" title="3. 指令：指引的直接链接">​</a></h4>
<p>第三个重要组成部分是<strong>明确的准则</strong>，它们定义了智能体的行为方式。Cline 通过精心设计的指令和系统提示，来确定其如何解决问题、与代码库进行交互以及保持编码标准。</p>
<p>这些指令不仅仅是简单的聊天回复。它们包含了复杂的推理  模式、错误处理策略和协作工作流程，这使得 Cline 能够真正成为你的编码伙伴。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="递归执行引擎">递归执行引擎<a href="#递归执行引擎" class="hash-link" aria-label="递归执行引擎的直接链接" title="递归执行引擎的直接链接">​</a></h3>
<p>理解这些组成部分只是开始。真正的强大之处在于它们如何通过递归执行协同工作。当你发送一个提示给 Cline 时，系统背后会发生一些奇妙的事情。</p>
<p>Cline 首先会根据你的工作空间、计算机环境和你提供的自定义指令来扩展其系统提示。这个增强后的提示，连同你整个对话历史，被传送到所选的模型中。接下来就是智能体的协调过程。
Cline 会自主地在递归循环中调用工具；它会不断调用自己，直到确定任务完成。模型会自行决定做什么、使用哪些工具，以及何时完成编码。</p>
<p>我们来看一个具体的例子。假设你告诉 Cline“在主页上添加一个新按钮。”接下来会发生以下事情：</p>
<p>步骤 1: 探索 模型可能首先调用 list_files 工具，以了解你的代码库结构。Cline 发送请求后，会收到一个目录列表。</p>
<p>步骤 2: 调查 拥有文件结构后，Cline 可能会递归地调用 read_file 工具，检查 homepage.tsx 文件，理解当前的实现，并确定在哪里添加按钮。</p>
<p>步骤 3: 实施 在掌握上下文后，Cline 调用 write_to_file 工具，生成所需的代码更改，添加具有适当样式和功能的按钮。</p>
<p>步骤 4: 完成 完成更改并确认没有错误后，Cline 调用 attempt_completion 工具，结束递归循环。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img14@main/2025/06/15/1749993685310-41a499e0-d393-45b7-8241-f794985a1082.png" alt="" class="img_ev3q"></p>
<p>在实际应用中，Cline 常常进行比这个简化示例更多的递归循环。关  键在于，每个决策（例如使用什么工具、如何解释结果、何时停止）都由模型根据当前的上下文和对任务的理解自主做出。</p>
<p>Cline 的开源透明性增加了一个重要的维度。不同于那些将决策过程隐藏的“黑箱”工具，Cline 提供了实时的透明度，可以查看每个文件的读取、每个工具的调用和每个决策。这种透明性不仅仅关乎信任，更关乎在人类对日益复杂的自动化进行监督和控制。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-13-cline-source-code-prompt.md">Cline 源码浅析 - Prompt 设计</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-13T00:00:00.000Z">2025年6月13日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前  端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<p>“Agent 就是如何拼出更好用的 Prompt”，虽然有点玩笑的意味，但也能说明一定的问题。本篇文章我们探讨下 Cline 里的 Prompt 设计。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-prompt">System Prompt<a href="#system-prompt" class="hash-link" aria-label="System Prompt的直接链接" title="System Prompt的直接链接">​</a></h2>
<p>众所周知，System Prompt 是 Agent 的核心资产😂，Github 上 <a href="https://github.com/x1xhlol/system-prompts-and-models-of-ai-tools" target="_blank" rel="noopener noreferrer">system-prompts-and-models-of-ai-tools</a> 这个仓库收集了各类 AI 应用的 System Prompt，已经有 56.6K 的 Star 了，可见一斑。</p>
<p>Cline 的 System Prompt 位于 <code>src/core/prompts/system.ts</code>，根据上下文信息、工具以及模型信息动态生成。</p>
<blockquote>
<p>You are Cline, a highly skilled software engineer with extensive knowledge in many programming languages, frameworks, design patterns, and best practices.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="工具-tool-use">工具 TOOL USE<a href="#工具-tool-use" class="hash-link" aria-label="工具 TOOL USE的直接链接" title="工具 TOOL USE的直接链接">​</a></h3>
<blockquote>
<p>You have access to a set of tools that are executed upon the user&#x27;s approval. You can use one tool per message, and will receive the result of that tool use in the user&#x27;s response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.</p>
</blockquote>
<p>我们自上而下的读一遍 System Prompt。</p>
<ol>
<li>工具调用格式</li>
</ol>
<p>首先告诉模型使用 XML 语法输出工具调用相关的内容。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">parameter1_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">value1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">parameter1_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">parameter2_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">value2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">parameter2_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>工具列表</li>
</ol>
<p>列举了 Cline 内置的工具，主要包括描述、参数以及使用 DEMO，比如 <code>write_to_file</code>：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> write_to_file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: Request to write content to a file at the specified path. If the file exists, it will be overwritten with the provided content. If the file doesn&#x27;t exist, it will be created. This tool will automatically create any directories needed to write the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> path: (required) The path of the file to write to (relative to the current working directory ${cwd.toPosix()})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> content: (required) The content to write to the file. ALWAYS provide the COMPLETE intended content of the file, without any truncation or omissions. You MUST include ALL parts of the file, even if they haven&#x27;t been modified.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">write_to_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">File path here</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your file content here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">write_to_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cline 内置了十多个工具，覆盖了命令行、文件操作、浏览器、MCP 等，这些工具极大的丰富了模型的能力。</p>
<ol start="3">
<li>工具调用 Example</li>
</ol>
<p>展示了多个工具调用的样例给模型参考：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> Tool Use Examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> Example 1: Requesting to execute a command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execute_command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">npm run dev</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">requires_approval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">requires_approval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execute_command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>工具使用指引</li>
</ol>
<p>这里相当于手把手教模型逐步思考如何使用工具（类似于思维链（CoT）），简单翻译如下：
1）首先，模型需要评估已经掌握的信息，使用 <code>&lt;thinking&gt;</code> 标签包裹。
2）根据任务和提供的工具描述，选择最合适的工具。
3）如果需要执行多个操作，请一次只使用一个工具，每一步都必须以前一步的结果为依据。
4）使用指定的 XML 格式来构建你的工具调用。
5）每次使用工具后，用户将回复该工具的执行结果。这个结果会为你提供继续任务或做出进一步决策所需的信息。
6）每次使用工具后，一定要等待用户的确认后再继续。</p>
<p>以上的操作，可以确保模型按步骤拆解任务，确认每步的成功与否，根据用户的反馈实时进行调整，保证工具使用和最终任务的正确性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mcp-server">MCP Server<a href="#mcp-server" class="hash-link" aria-label="MCP Server的直接链接" title="MCP Server的  直接链接">​</a></h3>
<p>这部分我们在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDA0MTE5Mw==&amp;mid=2247483942&amp;idx=1&amp;sn=70ad8830317f688b79d800c39b80a62d&amp;chksm=9b572020ac20a936dcd5606ed29690f3c2d4856b39a0e9193c52f64896d47e4bd064e9e4fc7d&amp;scene=178&amp;cur_album_id=4021745110793502724&amp;search_click_id=#rd" target="_blank" rel="noopener noreferrer">Cline 源码浅析 - MCP 调用</a>聊过，这里不再展开。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件编辑-editing-files">文件编辑 EDITING FILES<a href="#文件编辑-editing-files" class="hash-link" aria-label="文件编辑 EDITING FILES的直接链接" title="文件编辑 EDITING FILES的直接链接">​</a></h3>
<p>对于 Code Agent 文件编辑是非常重要的部分，这里再次强调了 <code>write_to_file</code> 和 <code>replace_in_file</code> 两个工具的使用：详细的使用时机以及重要提示。</p>
<p>再次以 workflow 的方式告诉模型使用文件编辑工具的最佳实践：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 在进行编辑之前，评估你更改的范围，并决定使用哪个工具。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 对于有针对性的修改，请使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 工具，并精心编写 SEARCH/REPLACE 块。如果你需要进行多项更改，可以在  一个 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 调用中堆叠多个 SEARCH/REPLACE 块。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 对于大规模重构或初始文件创建，请依赖 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 工具。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 一旦文件通过 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 或 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 被编辑，系统将向你提供修改后文件的最终状态。请将此更新后的内容作为后续所有 SEARCH/REPLACE 操作的参考点，因为它反映了任何自动格式化或用户手动应用的更改。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过在 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 和 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 之间做出深思熟虑的选择，你可以使文件编辑过程更加顺畅、安全和高效。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="act-mode-和-plan-mode">Act Mode 和 Plan Mode<a href="#act-mode-和-plan-mode" class="hash-link" aria-label="Act Mode 和 Plan Mode的直接链接" title="Act Mode 和 Plan Mode的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/11/1749631375428-9af1e1b3-f2d1-44bd-991e-c15f14b7cf96.png" alt="" class="img_ev3q"></p>
<p>Cline 提供了两种模式：Plan 和 Act。对于复杂任务，Cline 推荐从 Plan 模式开始，让模型先行规划策略，然后切换到 Act 模式，按照规划逐步实施，以提高代码输出质量。对话过程中，可以在两个模式中切换，就像人一样，写代码过程中，遇到问题，停下来思考。</p>
<p>System Prompt 里详细描述了两种模式的差异，重点描述了一下 Plan 模式的规则，比如使用 <code>read_file</code> <code>search_files</code> 等工具了解信息，特别推荐使用图表直观展示信息，并强调 Plan 模式下会使用 <code>plan_mode_respond</code> 工具回复信息。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="功能-capabilities">功能 CAPABILITIES<a href="#功能-capabilities" class="hash-link" aria-label="功能 CAPABILITIES的直接链接" title="功能 CAPABILITIES的直接链接">​</a></h3>
<p>这一大段相当于把上面的工具集进行了一次总结，告诉模型有用哪些能力，可以使用哪些特定工具来完成特定的功能，比如命令行：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">You can use the execute_command tool to run commands on the user&#x27;s computer whenever you feel it can help accomplish the user&#x27;s task. When you need to execute a CLI command, you must provide a clear explanation of what the command does. ......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="规则-rules">规则 RULES<a href="#规则-rules" class="hash-link" aria-label="规则 RULES的直接链接" title="规则 RULES的直接链接">​</a></h3>
<p>规则部分主要强调了什么可以做，什么不能做。比如不可以使用 ~ 或 $HOME 来表示用户的主目录，不可以使用 cd 命令，不能口语化，必须等待用户确认。这里使用了大量的<code>** **</code> 加粗的标记提醒模型。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="系统信息">系统信息<a href="#系统信息" class="hash-link" aria-label="系统信息的直接链接" title="系统信息的直接链接">​</a></h3>
<p>获取系统信息，这些可以帮助命令行工具、文本读写工具的执行。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Operating System</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">osName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Default Shell</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">getShell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Home Directory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">homedir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPosix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current Working Directory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cwd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPosix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="目标">目标<a href="#目标" class="hash-link" aria-label="目标的直接链接" title="目标的直接链接">​</a></h3>
<p>这里奠定了 Cline 处理问题的基调，我完整的贴在这里：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">你通过迭代的方式完成给定的任务，将其分解为清晰的步骤，并有条不紊地逐一执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">分析用户的任务</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，设定明确且可实现的目标以完成它。按逻辑顺序对这些目标进行优先级排序。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 依次处理这些目标，在必要时一次使用一个可用工具。每个目标应对应你解决问题过程中的一个具体步骤。在整个过程中，你会被告知已完成的工作和剩余的任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 请记住，你拥有广泛的工具能力，可以灵活、巧妙地运用这些工具来完成每一个目标。在调用任何工具之前，请在 </span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;thinking&gt;&lt;/thinking&gt;`</span><span class="token plain"> 标签中进行分析：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 首先，分析 </span><span class="token code-snippet code keyword" style="color:#00009f">`environment_details`</span><span class="token plain"> 中提供的文件结构，以获取上下文和洞察，从而有效地推进任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 然后，思考哪个可用工具最相关，能够帮助你完成用户任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 接着，逐个检查该工具所需的参数，并判断用户是否已直接提供或提供了足够的信息用于推断参数值。在决定能否推断某个参数值时，请仔细考虑所有上下文，看是否支持特定的取值。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果所有必需的参数都已存在或可以合理推断，则关闭 </span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;thinking&gt;`</span><span class="token plain"> 标签并继续执行工具操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">但如果有一个必需参数的值缺失</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要调用该工具</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">（即使填入占位符也不行），而是使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`ask_followup_question`</span><span class="token plain"> 工具向用户请求缺失的参数。如果未提供的是</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">可选参数</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，则</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要主动询问</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 完成用户的任务后，你必须使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`attempt_completion`</span><span class="token plain"> 工具将结果提交给用户。你也可以提供一条 CLI 命令来展示任务的结果；这对于 Web 开发任务尤其有用，例如你可以运行 </span><span class="token code-snippet code keyword" style="color:#00009f">`open index.html`</span><span class="token plain"> 来展示你构建的网站。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 用户可能会提供反馈，你可以根据反馈进行改进并重新尝试。但</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要陷入无意义的来回对话中</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，也就是说，</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要以问题或提供进一步帮助的提议结束你的回复</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义-system-prompt">自定义 System Prompt<a href="#自定义-system-prompt" class="hash-link" aria-label="自定义 System Prompt的直接链接" title="自定义 System Prompt的直接链接">​</a></h3>
<p>在 <code>addUserInstructions</code> 方法中，追加用户自定义的指令，这里包括了 <a href="https://docs.cline.bot/features/cline-rules" target="_blank" rel="noopener noreferrer">Cline Rules</a>。我们可以在项目根目录下新建 <code>.clinerules/</code> 存放 Cline Rule，Cline 作为 System Prompt 最有效的补充，可以针对不同的项目做不同的定制。</p>
<p>甚至追加了 Cursor 或者 Windsurf 的 Rule。😂</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localCursorRulesFileInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localCursorRulesFileInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localCursorRulesDirInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localCursorRulesDirInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localWindsurfRulesFileInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localWindsurfRulesFileInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="claude4-支持">Claude4 支持<a href="#claude4-支持" class="hash-link" aria-label="Claude4 支持的直接链接" title="Claude4 支持的直接链接">​</a></h3>
<p>Cline 3.17.9 版本对 Claude4 做了特殊支持 <code>src/core/prompts/model_prompts/claude4.ts</code> 以及 <code>src/core/prompts/model_prompts/claude4-experimental.ts</code>。据官方博客描述，在使用新的 Claude4 模型时，会遇到一些编辑错误。</p>
<blockquote>
<p>这次版本更新主要关注 Cline 与 Claude 4 之间的交互，尤其是在搜索和替换操作上。我们调整了分隔符方法，将 &lt; 和 &gt; 替换为 - 和 + ，这在我们的内部测试中显示出了积极的效果，减少了编辑失败，提高了代码修改的成功率。</p>
</blockquote>
<p>这也给我们带来了一些提示：在模型切换时，需要及时的测试和调整 Prompt，以更好的适应更新更强大的模型。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="command-和-workflow">Command 和 Workflow<a href="#command-和-workflow" class="hash-link" aria-label="Command 和 Workflow的直接链接" title="Command 和 Workflow的直接链接">​</a></h2>
<p>除了 Cline Rules，Cline 还提供了其他方式来让用户定制 Prompt。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="slash-command">Slash Command<a href="#slash-command" class="hash-link" aria-label="Slash Command的直接链接" title="Slash Command的直接链接">​</a></h3>
<p>Cline 提供了 Slash Command 的概念，通过 <code>/</code> 触发。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/06/11/1749635423130-0b111dc0-9024-4a6f-bdab-9ece17bf3e45.png" alt="" class="img_ev3q"></p>
<p>不像 Cline Rule 会针对每个任务生效，Command 在实现特定类型任务的时候很有用。比如我们要反馈 Bug，就可以使用内置的 <code>/reportBug</code> 触发任务。而比如在执行其他任务，比如写代码时，不带上这个命令，也就不会发送相应的提示词给模型。</p>
<p>Command 相应的提示词位于 <code>src/core/prompts/commands.ts</code>，提示词组装过程中，会调用 <code>src/core/slash-commands/index.ts</code> 文件的 <code>parseSlashCommands</code>  方法，将 <code>/</code> 命令替换为指定的提示词。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow">Workflow<a href="#workflow" class="hash-link" aria-label="Workflow的直 接链接" title="Workflow的直接链接">​</a></h3>
<p>如果要自定义 Command，除了源码层面定制，Cline 也支持用户手动配置，Cline 称其为 Workflow，Workflow 允许用户自定义步骤来处理特定的任务。在 <code>.clinerules</code> 目录下新建 <code>workflows</code> 目录，目录下新建 markdown 文件，文件内容我处理特定任务的步骤。这时候聊天框中输入 <code>/</code>，就会发现命令列表多了我们定制的 <code>/[workflow-name.md]</code>。</p>
<p>这部分逻辑依然在 <code>parseSlashCommands</code> 方法内，Command 和 Workflow 都会处理成 <code>/</code> 命令。</p>
<p>可以参照 Cline 仓库的 <code>.clinerules/workflows/pr-review.md</code> 编写自己的 Workflow。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mention-">Mention @<a href="#mention-" class="hash-link" aria-label="Mention @的直接链接" title="Mention @的直接链接">​</a></h2>
<p>@ 在 Cline 中是作为引用外部资源扩展上下文存在的。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img11@main/2025/06/11/1749649934154-2a274dec-1ff4-4c14-8e42-4e1a84366bc3.png" alt="" class="img_ev3q"></p>
<p>比如你可以 @ 一个文件路径，那这个文件的内容就会作为 Prompt 带给大模型。格式如下：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">file_content</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">path</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">path/to/file</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Complete file content]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">file_content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了文件，还可以 @ 问题、命令行甚至是一个 url，不必输入大段文字即可提供给模型更丰富的上下文信息。</p>
<p>mention 相关处理位于 <code>src/core/mentions/index.ts</code>，处理了各种 @ 信息。实践中，我们可以扩展 @能力，比如 @我们内部的知识库来让 Cline 更好的了解团队内部知识。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memery-bank">Memery Bank<a href="#memery-bank" class="hash-link" aria-label="Memery Bank的直接链接" title="Memery Bank的直接链接">​</a></h2>
<p>Memery Bank 是 Cline Agent 记忆系统的一个解决方案，[Cline Blog] 将 Memery Bank 比喻为笔记本，随着项目的更新持续的更新笔记，这样在开始新任务丢失历史记录和上下文的情况下，Cline 依旧可以通过笔记本里的内容了解项目全貌、技术架构以及当前进度等信息。</p>
<p>我们可以在 <code>.clinerules</code> 目录下新建 <code>memory-bank.md</code>，内容可以参照官方文档给出的<a href="https://docs.cline.bot/prompting/cline-memory-bank" target="_blank" rel="noopener noreferrer">示例</a>。</p>
<p>这份示例要求模型以如下的文档关系整理笔记本：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/06/12/1749734819909-17e56603-1947-4c2c-acac-4ec4a589f638.png" alt="" class="img_ev3q"></p>
<p>这六个文件分别作用为：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">projectbrief.md: 项目简介，奠定一切的基础文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productContext.md: 产品上下文，商业和用户视角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemPatterns.md: 技术架构与决策</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">techContext.md: 开发环境和技术栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activeContext.md: 当前开发状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">progress.md: 项目进度与跟踪</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际工作中，工作前需要确认 Memory Bank 文件，获取必要的上下文知识，如果项目有重大更新，则更新相关文档，以应对上下文丢失的情况。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img15@main/2025/06/12/1749735115693-dbaf9940-685d-4e0f-8842-0a56c94c845e.png" alt="" class="img_ev3q"></p>
<p>在 Memory Bank 中，Cline 提倡以 Mermaid 图表作为 Prompt，Cline 团队认为：</p>
<blockquote>
<p>与 AI 交流的最佳方式并非自然语言——而是工作流的结构化语言。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>Cline 的 Prompt 非常有<strong>模块化</strong>的设计思想。Cline 将 Prompt 划分为 System Prompt、Command、Workflow、Mention、Memery 等模块，System Prompt 则划分为工具、MCP、目标、Mode 等模块，针对全局、特定或者全新的任务使用不同的 Prompt 来解决。</p>
<p>同时我们也发现 Cline 事无巨细，非常“啰嗦”，比如 System Prompt 关于工具调用格式就出现了好几次；尽可能多的提供上下文，这让 Cline 非常的消耗 Token。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/05/30/1748572666434-e20a0717-a388-47c9-8332-832423e6b337.png" alt="openrouter 网站的统计，Cline 遥遥领先" class="img_ev3q"></p>
<p>如何写出好用的 Prompt，个人感觉主要是两点：</p>
<ol>
<li>足够的上下文和示例（身份、目标、工具、示例等等）</li>
<li>足够详细和明确的执行步骤（Workflow）</li>
</ol>
<p>最后，可以查看官方文档<a href="https://docs.cline.bot/prompting/prompt-engineering-guide" target="_blank" rel="noopener noreferrer">提示词工程指南</a>进一步了解如何为 Cline 写出更好用的 Prompt。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-10-cline-source-code-mcp.md">Cline 源码浅析 - MCP 调用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-10T00:00:00.000Z">2025年6月10日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>上一篇文章<a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">Cline 源码浅析 - 从输入到输出</a>，从源码角度浏览了一下 Cline 处理用户输入到最后输出的过程，本文看一下其中关于 MCP 的处理。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<blockquote>
<p>关于 MCP，可以查看<a href="https://modelcontextprotocol.io/introduction" target="_blank" rel="noopener noreferrer">官方文档</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cline-mcp">Cline MCP<a href="#cline-mcp" class="hash-link" aria-label="Cline MCP的直接链接" title="Cline MCP的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何配置-mcp-server">如何配置 MCP Server<a href="#如何配置-mcp-server" class="hash-link" aria-label="如何配置 MCP Server的直接链接" title="如何配置 MCP Server的直接链接">​</a></h3>
<p>我们打开 Cline 的 MCP 界面，可以看到 Cline 提供了多种配置 MCP 的方式：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img14@main/2025/06/09/1749464726040-18f47f48-723f-41ee-9d7f-59d2f65144e5.png" alt="" class="img_ev3q"></p>
<p>本质上都是将 MCP 配置写入设置目录下的 <code>cline_mcp_settings.json</code> 文件，这里我们配置一个根据姓名查询工号的 MCP Server。</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;mcpServers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name2empid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;autoApprove&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;disabled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;timeout&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;url&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://xxxx.com/xxx/sse&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sse&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>另外 Cline 自行维护了一个 MCP 市场，用户可以从中选择安装，Cline 提供了一个比较有意思的安装方式，当你点击 Install 的时候，他并不是简单的把配置写入配置文件，而是通过大模型来进行安装（从访问文档到安装到验证），代码位于 <code>src/core/controller/mcp/downloadMcp.ts</code>，提示词如下：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Create task with context from README and added guidelines for MCP server installation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Set up the MCP server from </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">githubUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> while adhering to these MCP server installation rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Start by loading the MCP documentation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Use &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">mcpId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&quot; as the server name in cline_mcp_settings.json.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Create the directory for the new MCP server before starting installation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Make sure you read the user&#x27;s existing cline_mcp_settings.json file before editing it with this new mcp, to not overwrite any existing servers.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Use commands aligned with the user&#x27;s shell and operating system best practices.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- The following README may contain instructions that conflict with the user&#x27;s OS, in which case proceed thoughtfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Once installed, demonstrate the server&#x27;s capabilities by using one of its tools.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">Here is the project&#x27;s README to help you get started:\n\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">readmeContent</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">llmsInstallationContent</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="源码阅读">源码阅读<a href="#源码阅读" class="hash-link" aria-label="源码阅读的直接链接" title="源码阅读的直接链接">​</a></h3>
<p>MCP 配置相关的代码位于：<code>src/services/mcp/McpHub.ts</code>，这里本质就是一个 MCP Client 初始化的逻辑，根据配置连接 Server 获取 Tool。</p>
<p>连接的 Server 的代码位于 <code>connectToServer</code>，调用 <code>@modelcontextprotocol/sdk/client</code> 这个包初始化 Client。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cline&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clientVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capabilities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 处理不同的类型的 Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StdioClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SSEClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StreamableHTTPClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后获取 tool 和 resource：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Initial fetch of tools and resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tools </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchToolsList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchResourcesList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceTemplates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchResourceTemplatesList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>MCP Client 的工作初始化完成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mcp-的使用">MCP 的使用<a href="#mcp-的使用" class="hash-link" aria-label="MCP 的使用的直接链接" title="MCP 的使用的直接链接">​</a></h2>
<p>下面看一下我们配置好的 MCP Server 是如何在我们的任务中运作的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="system-prompt">System Prompt<a href="#system-prompt" class="hash-link" aria-label="System Prompt的直接链接" title="System Prompt的直接链接">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">上一篇文章</a>我们得知，System Prompt 是实时拼接的，这里把 MCP Server 相关的 Prompt 贴在这里：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> systemPrompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">MCP SERVERS</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">The Model Context Protocol (MCP) enables communication between the system and locally running MCP servers that provide additional tools and resources to extend your capabilities.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"># Connected MCP Servers</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">When a server is connected, you can use the server&#x27;s tools via the \`use_mcp_tool\` tool, and access the server&#x27;s resources via the \`access_mcp_resource\` tool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">	mcpHub</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">getServers</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">length </span><span class="token template-string interpolation operator" style="color:#393A34">&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:#36acaa">0</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">		</span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> `$</span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation">mcpHub</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">getServers</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">filter</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">status </span><span class="token template-string interpolation operator" style="color:#393A34">===</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;connected&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> tools </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">tool</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">							</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> schemaStr </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> tool</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">inputSchema</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">								</span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">    Input Schema:</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation template-string string" style="color:#e3116c">    </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation constant" style="color:#36acaa">JSON</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">stringify</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">inputSchema</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">,</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation keyword" style="color:#00009f">null</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">,</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation number" style="color:#36acaa">2</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">split</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;\n    &quot;</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">								</span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">							</span><span class="token template-string interpolation keyword" style="color:#00009f">return</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">: </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">schemaStr</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> templates </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">resourceTemplates</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">template</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">uriTemplate</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">): </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> resources </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">resource</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">uri</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">): </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> config </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation constant" style="color:#36acaa">JSON</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">parse</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">config</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">return</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">## </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">server</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (\`</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">command</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">args </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">&amp;&amp;</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation builtin">Array</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">isArray</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">args</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string interpolation template-string string" style="color:#e3116c"> </span><span class="token template-string interpolation template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation template-string interpolation">args</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation template-string interpolation string" style="color:#e3116c">&quot; &quot;</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\`)</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">tools </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Available Tools\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tools</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">templates </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Resource Templates\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">templates</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">resources </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Direct Resources\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resources</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">				.join(&quot;\n\n&quot;)}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;(No MCP servers currently connected)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>MCP Server 的相关提示词在 System Prompt  Tool Use Guidelines 部分，通过遍历 McpHub 内所有 server，将 server 内的 tool 格式化的拼接到 Prompt 中。大致格式为：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> name2empid(node xxx.ts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> Available Tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> get_empid_by_name: 根据员工姓名查询工号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	Input Schema: {&quot;name&quot;: &quot;string&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同时还提供给模型一个调用 MCP Server Tool 的示例：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> Example 5: Requesting to use an MCP tool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">weather-server</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">get_forecast</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;city&quot;: &quot;San Francisco&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;days&quot;: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>涉及到 MCP 调用统一使用 <code>use_mcp_tool</code> 工具，然后再指定是哪个 MCP 工具。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模型调用">模型调用<a href="#模型调用" class="hash-link" aria-label="模型调用的直接链接" title="模型调用的直接链接">​</a></h3>
<p>比如我们问“查询张三的工号”，模型输出类似下面这样：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我需要查询&quot;张三&quot;的工号。根据任务描述，我需要使用name2empid MCP服务器提供的工具来获取员工的工号。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我可以使用</span><span class="token code-snippet code keyword" style="color:#00009f">`use_mcp_tool`</span><span class="token plain">工具来调用name2empid服务器的</span><span class="token code-snippet code keyword" style="color:#00009f">`get_empid_by_name`</span><span class="token plain">工具，该工具 可以根据员工姓名获取工号。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要的参数是:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> server_name: &quot;name2empid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tool_name: &quot;get_empid_by_name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arguments: 包含员工姓名的JSON对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我已经有了所有必要的信息，可以直接调用这个工具。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name2empid</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">get_empid_by_name</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;张三&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>经过 <code>parseAssistantMessageV2</code> 和 <code>presentAssistantMessage</code>  两个方法，会从模型输出中解析出使用的 MCP Tool 以及参数，和内置的 Tool 逻辑基本类似。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;use_mcp_tool&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">server_name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;name2empid&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tool_name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;get_empid_by_name&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{\n  &quot;name&quot;: &quot;张三&quot;\n}&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{\n  &quot;name&quot;: &quot;张三&quot;\n}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;name2empid&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tool_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;get_empid_by_name&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时，Cline 会执行 McpHub 内的 <code>callTool</code> 方法获取结果，后面再将结果交给模型，得到最终输出，自此任务结束。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>如果觉得 Cline 源码太复杂，可以直接看 <a href="https://modelcontextprotocol.io/quickstart/client#node" target="_blank" rel="noopener noreferrer">MCP 官方的 Client DEMO</a>，比较清晰。</p>
<p>MCP 大大扩展了模型能力，可以在让模型发挥更好的价值。Cline 在 MCP 的管理和调用上设计的都很巧妙，尤其是 System Prompt，下一篇文章我们将探讨一下 Cline 的 Prompt 设计。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-07-cline-source-code-1.md">Cline 源码浅析 - 从输入到输出</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-07T00:00:00.000Z">2025年6月7日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<p>我们在上一篇文章：<a href="https://mp.weixin.qq.com/s/EkGEk3UrZvxIH2VV0DWdLA" target="_blank" rel="noopener noreferrer">现在开始使用 Cline Rules</a> 里简单介绍过 Cline，本篇文章从源码角度来看一下从我们输入指令到 Cline 输出的过程到底是怎样的，这样对我们后续使用 Cline 会有更好的帮助。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动-cline">启动 Cline<a href="#启动-cline" class="hash-link" aria-label="启动 Cline的直接链接" title="启动 Cline的直接链接">​</a></h2>
<p>访问 Cline 的 Github 仓库 README：<a href="https://github.com/cline/cline?tab=readme-ov-file#contributing%EF%BC%9A" target="_blank" rel="noopener noreferrer">https://github.com/cline/cline?tab=readme-ov-file#contributing：</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cline/cline.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code cline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm run install:all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 VSCode 里 <code>F5</code> 或者 <code>Run-&gt;Start Debugging</code> 开始调试 Cline VSCode 插件。此时会新开一个 VSCode 窗口，这个窗口里我们可以愉快的调试 VSCode。</p>
<blockquote>
<p>这里可能遇到一些问题，一个是仓库里提到的，如果构建有问题，需要安装 <a href="https://marketplace.visualstudio.com/items?itemName=connor4312.esbuild-problem-matchers" target="_blank" rel="noopener noreferrer">esbuild Problem Matchers插件</a>；另外项目的 Webview 里需要安装 electron 这个巨无霸，可能会很慢，可以设置为国内源：</p>
</blockquote>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">electron_mirror=https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//npmmirror.com/mirrors/electron/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">electron_builder_binaries_mirror=https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//npmmirror.com/mirrors/electron</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">binaries/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shamefully</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hoist=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-debug">Step by Step Debug<a href="#step-by-step-debug" class="hash-link" aria-label="Step by Step Debug的直接链接" title="Step by Step Debug的直接链接">​</a></h2>
<p>VSCode 对自家插件的调试做的非常好，不管是 VSCode 主进程还是 Webview 内容，下面就一步一步的开始调试。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="前端输入">前端输入<a href="#前端输入" class="hash-link" aria-label="前端输入的直接链接" title="前端输入的直接链接">​</a></h3>
<p>我们准备一段简单的输入：创建一个新任务，实现快速排序算法，并插入到 utils 文件内。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/newtask 实现快速排序算法，写入 @/src/utils/index.ts 文件</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>这里使用了 Cline 的内置的两个功能：内置命令 Command /newtask 以及 mention @ 功能指定了写入的文件。Command 可以理解为指定特定任务的 prompts，方便执行一些高频操作的任务，Cline 内置了诸如新建任务、创建 Rule、创建 Github Issue 等 Command。@ 功能可以指定模型特别关注的上下文，比如指定的文件内容，指定的目录内容。</p>
</blockquote>
<p>输入框内输入上述内容，点击发送，代码文件：<code>webview-ui/src/components/chat/ChatView.tsx</code>，发送消息的方法为 <code>handleSendMessage</code>，Webview 内只负责收集输入信息，实际任务处理的逻辑都会发送至 VSCode 的主进程内，VSCode 主进程处理过程中，会实时的发送消息回 Webview。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 文件位置 webview-ui/src/services/grpc-client-base.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;message&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handleResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Send the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> encodedRequest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">encodeRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vscode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;grpc_request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grpc_request</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fullName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// method 为 newTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> encodedRequest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// message 为输入的文本、图片、文件消息等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_streaming</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>message 的格式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">files =(0) []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images =(0) []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text =&#x27;/newtask 创建一个快速排序算法，写入 @/src/utils/index.ts 文件&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>VSCode 主进程接收 <code>grpc_request</code> 消息进行处理。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vscode-主进程接收消息">VSCode 主进程接收消息<a href="#vscode-主进程接收消息" class="hash-link" aria-label="VSCode 主进程接收消息的直接链接" title="VSCode 主进程接收消息的直接链接">​</a></h3>
<p>主进程处理的内容位于：<code>src/core/controller/grpc-handler.ts</code>：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * Handle a gRPC request from the webview</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">service</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The service name</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The method name</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">message</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The request message</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">requestId</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The request ID for response correlation</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">isStreaming</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Whether this is a streaming request</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The response message or error for unary requests, void for streaming requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		requestId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		isStreaming</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		message</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		error</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		request_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，参数和 Webview 传过来的一致。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="任务初始化">任务初始化<a href="#任务初始化" class="hash-link" aria-label="任务初始化的直接链接" title="任务初始化的直接链接">​</a></h3>
<p>经过各种封装，最终处理的任务落到了 <code>src/core/controller/index.ts</code> 的 <code>initTask</code> 方法内一个超级大的 Task 类的初始化：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpHub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">workspaceTracker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">historyItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateTaskHistory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">historyItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postStateToWebview</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postMessageToWebview</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reinitExistingTaskFromId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cancelTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiConfiguration</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  autoApprovalSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  browserSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chatSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shellIntegrationTimeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terminalReuseEnabled </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableCheckpointsSetting </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  files</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  historyItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Task 类位于 <code>src/core/task/index.ts</code>，</p>
<p>在一系列的初始化后：</p>
<blockquote>
<p>初始化的代码没有过度深究，从类名来看，包括了后续任务执行中可能使用到的工具：浏览器、命令行、Url、DiffView 等；mcp 的配置；autoApproval 的配置等等。</p>
</blockquote>
<p>终于进入到实际的逻辑处理：</p>
<p>首先，根据用户配置的模型提供商信息创建 AI 的 api handler：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Now that taskId is initialized, we can build the API handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">api </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildApiHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectiveApiConfiguration</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，进入到 <code>startTask</code> 方法：</p>
<p>say 方法会在聊天面板新增一条消息，比如下面的代码，将用户的输入信息显示在聊天面板：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img4@main/2025/06/06/1749196272451-b424c65b-cb65-411f-9cbb-92322d586b92.png" alt="" class="img_ev3q"></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">say</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="构建-user-prompt">构建 User Prompt<a href="#构建-user-prompt" class="hash-link" aria-label="构建 User Prompt的直接链接" title="构建 User Prompt的直接链接">​</a></h3>
<p>接下来，构建 userContent：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 为用户输入的消息添加一个 task 标签。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> userContent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UserContent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">&lt;task&gt;\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">task</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">\n&lt;/task&gt;</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">imageBlocks</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">输出：</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">text =</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">&#x27;&lt;task&gt;\n/newtask 创建一个快速排序算法，写入 @/src/utils/index.ts 文件\n&lt;/task&gt;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">type =</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">&#x27;text&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果用户提供了文件（Cline 支持用户上传文本文件），背后其实是读完文本文本，也用来构造 userContent。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">files </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fileContentString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processFilesIntoText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">files</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileContentString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> fileContentString</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="继续构造-prompts">继续构造 Prompts<a href="#继续构造-prompts" class="hash-link" aria-label="继续构造 Prompts的直接链接" title="继续构造 Prompts的直接链接">​</a></h3>
<p>用过 Cline 的话，我们会知道 Cline 会循环处理任务，所以 User Prompts 构造完成后，进入到 <code>initiateTaskLoop</code> 方法，真正执行任务的方法为 <code>recursivelyMakeClineRequests</code>：</p>
<p>进一步处理用户的输入信息：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">parsedUserContent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environmentDetails</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clinerulesError</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">loadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userContent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> includeFileDetails</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样处理之后，用户输入重新组装为 parsedUserContent，内容比较长，这里不贴了，大致格式为：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">explicit_instructions</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">new_task</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">explicit_instructions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">task</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">用户输入</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">task</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">fileContent</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">src/utils/index.ts内的文件</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">fileContent</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>再次看一下我们的输入：<code>/newtask 实现快速排序算法，写入 @/src/utils/index.ts 文件</code>，上面三段一一对应：<code>\&lt;explicit_instructions type=&quot;new_task\&gt;&quot;</code> 对应 /newtask 命令，这是 Cline 的内置 prompt，@/src/utils/index.ts 添加了该文件内容作为上下文。</p>
<p>同时将 environmentDetails 也添加到 userContent，environmentDetails 有工作目录、当前时间、当前打开的 Tab 等。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">userContent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parsedUserContent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// add environment details as its own text block, separate from tool results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">userContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> environmentDetails </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>怪不得 Cline 这么耗 Token！</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模型请求">模型请求<a href="#模型请求" class="hash-link" aria-label="模型请求的直接链接" title="模型请求的直接链接">​</a></h3>
<p>继续进入 <code>attemptApiRequest</code> 方法，首先构造 System prompt：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isClaude4ModelFamily </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isClaude4ModelFamily</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> systemPrompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SYSTEM_PROMPT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cwd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> supportsBrowserUse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpHub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">browserSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isClaude4ModelFamily</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比较有意思的是，Cline 针对 Claude4 定制了不同的 System Prompt。</p>
<blockquote>
<p>System Prompt 里会告诉模型我们当前已经提供了哪些工具以及这些工具该如何调用（参数和规则），比如本次任务要将模型生成的代码写入已有文件，那么就需要使用到 <code>replace_in_file</code> 这个工具，这里贴一下 System Prompt 里关于  <code>replace_in_file</code> 的内容。</p>
</blockquote>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> replace_in_file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: Request to replace sections of content in an existing file using SEARCH/REPLACE blocks that define exact changes to specific parts of the file. This tool should be used when you need to make targeted changes to specific parts of a file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> path: (required) The path of the file to modify (relative to the current working directory ${cwd.toPosix()})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> diff: (required) One or more SEARCH/REPLACE blocks following this exact format:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  \`\`\`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ------- SEARCH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [exact content to find]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  =======</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [new content to replace with]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  +++++++ REPLACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  \`\`\`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Critical rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> SEARCH content must match the associated file section to find EXACTLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Match character-for-character including whitespace, indentation, line endings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include all comments, docstrings, etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> SEARCH/REPLACE blocks will ONLY replace the first match occurrence.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Including multiple unique SEARCH/REPLACE blocks if you need to make multiple changes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">just</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"> enough lines in each SEARCH section to uniquely match each set of lines that need to change.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> When using multiple SEARCH/REPLACE blocks, list them in the order they appear in the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> Keep SEARCH/REPLACE blocks concise:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Break large SEARCH/REPLACE blocks into a series of smaller blocks that each change a small portion of the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include just the changing lines, and a few surrounding lines if needed for uniqueness.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Do not include long runs of unchanging lines in SEARCH/REPLACE blocks.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Each line must be complete. Never truncate lines mid-way through as this can cause matching failures.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> Special operations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> To move code: Use two SEARCH/REPLACE blocks (one to delete from original + one to insert at new location)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> To delete code: Use empty REPLACE section</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">File path here</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Search and replace blocks here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同时，System Prompt 也继续追加了用户的偏好语言，方便按照用户偏好的语言进行输出。</p>
<p>接下来发送请求：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">systemPrompt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contextManagementMetadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">truncatedConversationHistory</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>针对模型的输出，需要进一步处理，是直接展示在聊天面板，还是需要调用工具处理，这部分逻辑在 <code>src/core/assistant-message/parse-assistant-message.ts</code> 的 <code>parseAssistantMessageV2</code> 方法内。</p>
<p>针对我们本次创建排序算法的任务，下面是一个模型输出样例：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n我需要在</span><span class="token code-snippet code keyword" style="color:#00009f">`src/utils/index.ts`</span><span class="token plain">文件中添加一个快速排序算法。首先，我已经看到了文件的内容，这是一个工具函数集合文件，包含了各种实用函数，如rpx转换、vw计算、类型检查、日志记录等。\n\n我需要在这个文件中添加一个快速排序算法实现。快速排序是一种高效的排序算法，基于分治法的思想。我将实现一个通用的快速排序函数，可以对数组进行排序。\n\n我将使用</span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain">工具来修改文件，在文件末尾添加快速排序算法的实现。我需要确保添加的代码与现有代码风格保持一致，并提供适当的类型注解和注释。\n\n我将在文件末尾添加快速排序算法的实现，包括：\n1. 一个主快速排序函数，接受一个数组和可选的比较函数\n2. 一个辅助函数用于分区操作\n\n让我使用</span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain">工具来修改文件。\n</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">src/utils/index.ts</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n------- SEARCH\nexport const jump2UpdateApp = () =&gt; {\n  if (is… (a, b) =&gt; {\n  if (a &lt; b) return -1;\n  if (a &gt; b) return 1;\n  return 0;\n}): T[] =&gt; {\n  // 创建数组副本，不修改原数组\n  const result = [...arr];\n  \n  // 内部快速排序实现\n  const _quickSort = (arr: T[], left: number, right: number) =&gt; {\n    if (left &lt; right) {\n      const pivotIndex = partition(arr, left, right);\n      _quickSort(arr, left, pivotIndex - 1);\n      _quickSort(arr, pivotIndex + 1, right);\n    }\n  };\n  \n  // 分区操作\n  const partition = (arr: T[], left: number, right: number): number =&gt; {\n    // 选择最右边的元素作为基</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>parseAssistantMessageV2</code> 方法会解析上述输出内容，主要是从模型输出中解析出使用哪些工具以及工具的参数，比如这里我们发现模型输出中有 &lt;replace_in_file&gt;，那就说明这次需要使用 replace_in_file 工具。</p>
<p>接下来调用 <code>presentAssistantMessage</code> 方法真正将模型消息展示给用户，一方面展示文本消息，类似下图：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img9@main/2025/06/06/1749217048970-dba8c0b7-c03c-4767-a014-845c105ab0d9.png" alt="" class="img_ev3q"></p>
<p>一方面执行上一步解析出的 tool，将模型生成代码以 diff 的方式写入文件，这里借助 VSCode 的能力创建 diffView。自此这个任务算是完成了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>抛开 Cline 中用户交互和工程处理的部分，我们发现最核心的其实只有两件事情：</p>
<ol>
<li>
<p>prompt 组装。这其中包括了 System Prompt、VSCode 和系统的环境信息、内置 Command、内置的 @ 引用（文件、目录信息）、用户的输入（文本、图片、文本文件），当然还有我们之前介绍的 Rules 以及我们提到过的 Workflow（本质是用户自定义的 Command）。这些内容共同组装称为 Prompt 发送给模型，力求给模型足够多的上下文信息，获得更加准确的结果。</p>
</li>
<li>
<p>tools 调用。首先在 System Prompt 定义了模型可以调用的 Tool（包括内置的和 MCP Server 定义的），在模型输出时指定调用的 Tool 和需要的参数，以此斤进一步增强模型的能力。</p>
</li>
</ol>
<p>两者共同合作完成用户的编码的任务。</p>
<p>由此我们可以看到 Agent 开发中最重要的三点：</p>
<ol>
<li>模型的使用</li>
<li>丰富的创意</li>
<li>丝滑的体验</li>
</ol>
<p>最后，本文是在我边调试边写作的过程中完成的，可能表达还不够清晰，欢迎有兴趣的同学一起交流指正。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-05-30-cline-rule.md">现在开始使用 Cline Rules</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-30T00:00:00.000Z">2025年5月30日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/05/30/1748588412574-e064741c-0bf1-4c61-be3c-fd9ac86453e4.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="写在前面">写在前面<a href="#写在前面" class="hash-link" aria-label="写在前面的直接链接" title="写在前面的直接链接">​</a></h3>
<p>最近在业务（面向用户的 C 端业务）中较多的使用了 <a href="https://docs.cline.bot/getting-started/what-is-cline" target="_blank" rel="noopener noreferrer">Cline</a>，总体感觉非常丝滑（尤其是看着他在默默地生成代码并且自己排查错误的时候，但 Token 确实也消耗的很快😂）。</p>
<p>Cline 算是 VS Code AI 开发插件中的佼佼者了，并且是一个开源项目，他的一个 fork 分支 RooCode 热度也很高。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/05/30/1748572666434-e20a0717-a388-47c9-8332-832423e6b337.png" alt="openrouter 网站的统计，Cline 遥遥领先" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开始配置-cline-rules">开始配置 Cline Rules<a href="#开始配置-cline-rules" class="hash-link" aria-label="开始配置 Cline Rules的直接链接" title="开始配置 Cline Rules的直接链接">​</a></h3>
<p>作为一个通用的编程助手，如何能针对不同的项目进行更好的开发，除了 Cline 本身对代码的理解之外，作为用户如果能提供更多的指引，可以让 Cline 发挥更好的作用。</p>
<p>一般来说，Cline、Cursor 及其他代码 Agent  都会提供 rules 这个概念，在项目根目录下新建 rules 目录，目录下根据自己的项目可以新建各种规则文件。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">your-project/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── .clinerules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		├── project.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── api.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── docs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	└── ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你的规则全局通用，可以将规则放置到 <code>Documents/Cline/Rules</code> 目录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cline-rules-优势">Cline Rules  优势<a href="#cline-rules-优势" class="hash-link" aria-label="Cline Rules 优势的直接链接" title="Cline Rules 优势的直接链接">​</a></h3>
<p>放在项目内好处很明显：</p>
<ol>
<li>可以针对每个项目配置不同的规则；</li>
<li>作为项目源代码的一部分，进行版本控制，持续维护，跟随项目发展设置长远的 rule；</li>
<li>保证团队成员使用 AI 的行为是一致的。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cline-rules-的原则">Cline Rules 的原则<a href="#cline-rules-的原则" class="hash-link" aria-label="Cline Rules 的原则的直接链接" title="Cline Rules 的原则的直接链接">​</a></h3>
<ol>
<li>清晰简洁：使用简单语言，避免歧义。</li>
<li>关注期望结果：描述你想要的结果，而不是具体步骤。</li>
<li>测试和迭代：试验找出最适合你的工作流程的方法。</li>
</ol>
<p>rules 本质上是自定义 prompts，和 Cline 的 system prompts 互为补充，共同为项目服务。（system promps：<a href="https://github.com/cline/cline/blob/main/src/core/prompts/model_prompts/claude4.ts%EF%BC%89" target="_blank" rel="noopener noreferrer">https://github.com/cline/cline/blob/main/src/core/prompts/model_prompts/claude4.ts）</a></p>
<p>关于提示词，我之前有总结过<a href="https://mp.weixin.qq.com/s/YFV0MO_pX3Us-PEMzxF0vQ" target="_blank" rel="noopener noreferrer">谷歌的提示词最佳实践</a>，可以看一下。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高级用法-rules-bank">高级用法 Rules Bank<a href="#高级用法-rules-bank" class="hash-link" aria-label="高级用法 Rules Bank的直接链接" title="高级用法 Rules Bank的直接链接">​</a></h3>
<p>Rules Bank 顾名思义，就是存放 Rules 的地方，如果你的项目很复杂，又有前端、又有后端、又有不同的技术栈，这个时候就很有用。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">your-project/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── .clinerules/              # Active rules - automatically applied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── 01-coding.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── client-a.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── clinerules-bank/          # Repository of available but inactive rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── clients/              # Client-specific rule sets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── client-a.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── client-b.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── frameworks/           # Framework-specific rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── react.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── vue.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── project-types/        # Project type standards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── api-service.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── frontend-app.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比如当你在开发 React 技术栈的时候，从 Rules Bank 中复制 React Rule 到 Cline Rules 内。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Switch to React</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm .clinerules/vue.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp clinerules-bank/clients/react.md .clinerules/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总之一切文本放到代码仓库中，提高可持续性，并且可以跟随项目保持最新的迭代！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何管理">如何管理<a href="#如何管理" class="hash-link" aria-label="如何管理的直接链接" title="如何管理的直接链接">​</a></h3>
<p>Cline 提供了一种方便的方式管理 Rules，在输入框下方一个天平的小标志内，可以打开 Rule 管理器，新增删除或者启用禁用 Rule。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/05/30/1748590113024-f84df6e2-374d-4378-b4af-79b8b7ed9f86.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="#最后" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h3>
<p>十分建议你在平时工作中使用 Cline，并使用 Cline Rule 增强开发体验。后面会持续更新 Cline 的相关内容。</p>
<p>最后，假期快乐！</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div></div>
</body>
</html>