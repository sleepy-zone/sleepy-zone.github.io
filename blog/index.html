<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Blog | 😴 Sleepy Zone</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sleepy-zone.github.io/blog"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | 😴 Sleepy Zone"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://sleepy-zone.github.io/blog"><link data-rh="true" rel="alternate" href="https://sleepy-zone.github.io/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://sleepy-zone.github.io/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://sleepy-zone.github.io/blog","mainEntityOfPage":"https://sleepy-zone.github.io/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-06-13-cline-source-code-prompt.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-06-13-cline-source-code-prompt.md","url":"https://sleepy-zone.github.io/blog/2025-06-13-cline-source-code-prompt.md","headline":"Cline 源码浅析 - Prompt 设计","name":"Cline 源码浅析 - Prompt 设计","description":"“Agent 就是如何拼出更好用的 Prompt”，虽然有点玩笑的意味，但也能说明一定的问题。本篇文章我们探讨下 Cline 里的 Prompt 设计。","datePublished":"2025-06-13T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-06-10-cline-source-code-mcp.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-06-10-cline-source-code-mcp.md","url":"https://sleepy-zone.github.io/blog/2025-06-10-cline-source-code-mcp.md","headline":"Cline 源码浅析 - MCP 调用","name":"Cline 源码浅析 - MCP 调用","description":"上一篇文章Cline 源码浅析 - 从输入到输出，从源码角度浏览了一下 Cline 处理用户输入到最后输出的过程，本文看一下其中关于 MCP 的处理。","datePublished":"2025-06-10T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-06-07-cline-source-code-1.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-06-07-cline-source-code-1.md","url":"https://sleepy-zone.github.io/blog/2025-06-07-cline-source-code-1.md","headline":"Cline 源码浅析 - 从输入到输出","name":"Cline 源码浅析 - 从输入到输出","description":"我们在上一篇文章：现在开始使用 Cline Rules 里简单介绍过 Cline，本篇文章从源码角度来看一下从我们输入指令到 Cline 输出的过程到底是怎样的，这样对我们后续使用 Cline 会有更好的帮助。","datePublished":"2025-06-07T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-05-30-cline-rule.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-05-30-cline-rule.md","url":"https://sleepy-zone.github.io/blog/2025-05-30-cline-rule.md","headline":"现在开始使用 Cline Rules","name":"现在开始使用 Cline Rules","description":"写在前面","datePublished":"2025-05-30T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-30-ts-agent-mastra.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-30-ts-agent-mastra.md","url":"https://sleepy-zone.github.io/blog/2025-04-30-ts-agent-mastra.md","headline":"Mastra  - TypeScript AI Agent 框架","name":"Mastra  - TypeScript AI Agent 框架","description":"简介","datePublished":"2025-05-21T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-30-deepwiki.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-30-deepwiki.md","url":"https://sleepy-zone.github.io/blog/2025-04-30-deepwiki.md","headline":"DeepWiki - 阅读开源代码的神器","name":"DeepWiki - 阅读开源代码的神器","description":"以后推荐开源项目：","datePublished":"2025-04-30T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-24-google-promtps-2.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-24-google-promtps-2.md","url":"https://sleepy-zone.github.io/blog/2025-04-24-google-promtps-2.md","headline":"谷歌提示词工程 - 最佳实践","name":"谷歌提示词工程 - 最佳实践","description":"接上文谷歌提示词工程 - 模型原理和提示词技术，讨论提示词的最佳实践。","datePublished":"2025-04-24T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-23-google-promtps.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-23-google-promtps.md","url":"https://sleepy-zone.github.io/blog/2025-04-23-google-promtps.md","headline":"谷歌提示词工程 - 模型原理和提示词技术","name":"谷歌提示词工程 - 模型原理和提示词技术","description":"谷歌前段时间发布了提示词工程白皮书，已经有很多博主推荐了，最近终于有时间阅读一下。以下是笔记记录。","datePublished":"2025-04-23T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-21-old-fe-1.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-21-old-fe-1.md","url":"https://sleepy-zone.github.io/blog/2025-04-21-old-fe-1.md","headline":"盘点前端还在更新的老项目","name":"盘点前端还在更新的老项目","description":"今天不聊 AI，聊点前端。冒着暴露年龄的风险聊点前端里还在更新的老项目。","datePublished":"2025-04-21T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]},{"@type":"BlogPosting","@id":"https://sleepy-zone.github.io/blog/2025-04-14-github-no-vistit.md","mainEntityOfPage":"https://sleepy-zone.github.io/blog/2025-04-14-github-no-vistit.md","url":"https://sleepy-zone.github.io/blog/2025-04-14-github-no-vistit.md","headline":"从 Github 不能访问想到的","name":"从 Github 不能访问想到的","description":"上周末中国未登录用户无法访问 Github，瞬间在社交媒体引起轩然大波。","datePublished":"2025-04-14T00:00:00.000Z","author":{"@type":"Person","name":"SleepyZone","description":"前端开发 / 开源爱好者","url":"https://github.com/sleepy-zone","image":"https://avatars.githubusercontent.com/u/131369648?v=4"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="😴 Sleepy Zone RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="😴 Sleepy Zone Atom Feed">





<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap">
<script>!function(t,e,n,a,c,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(a)).async=1,r.src="https://www.clarity.ms/tag/r1wmvdsf4a",(s=e.getElementsByTagName(a)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/assets/css/styles.5d8c36ea.css">
<script src="/assets/js/runtime~main.42b02de1.js" defer="defer"></script>
<script src="/assets/js/main.27ecf4cf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Sleepy Zone Site Logo" class="themedComponent__dKv themedComponent--light_rzkv"><img src="/img/logo.svg" alt="Sleepy Zone Site Logo" class="themedComponent__dKv themedComponent--dark_mMAk"></div><b class="navbar__title text--truncate">Sleepy Zone</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">🔥博客</a><a class="navbar__item navbar__link" href="/thoughts">💡想法</a><a class="navbar__item navbar__link" href="/weekly/2025-04-23">📚不周刊</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-13-cline-source-code-prompt.md">Cline 源码浅析 - Prompt 设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-10-cline-source-code-mcp.md">Cline  源码浅析 - MCP 调用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-06-07-cline-source-code-1.md">Cline 源码浅析 - 从输入到输出</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-05-30-cline-rule.md">现在开始使用 Cline Rules</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-30-ts-agent-mastra.md">Mastra  - TypeScript AI Agent 框架</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-30-deepwiki.md">DeepWiki - 阅读开源代码的神器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-24-google-promtps-2.md">谷歌提示词工程 - 最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-23-google-promtps.md">谷歌提示词工程 - 模型原理和提示词技术</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-21-old-fe-1.md">盘点前端还在更新的老项目</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-14-github-no-vistit.md">从 Github 不能访问想到的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-10-what-is-agent.md">什么是 Agent</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-07-deepsite.md">DeepSite：基于 DeepSeek 的生码应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-04-06-recent-ai-1.md">最近几件关于 AI 的事情</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-28-mcp.md">MCP - AI 和真实世界的桥梁</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-26-dev-mcp-server.md">动手开发一个 MCP Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-21-woocs">woocs，基于 doocs/md 的微信 Markdown 编辑器桌面应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-20-vibe-coding">聊聊 vibe coding</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-19-doocs-md">【开源推荐】高度简洁的微信 Markdown 编辑器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-17-ai-fomo">AI 浪潮下的 FOMO 情绪</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-03-10-D2">D2 终端技术大会之旅</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-02-25-2025-ai-first">2025 年或许是中国的 AI 元年</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025-02-19-we-are-destroying-software">【好文推荐】我们正在摧毁软件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ai-replace-fe">AI 可以取代前端吗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/my-2024">迟来的 2024 总结</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/antd-meetup">Ant Design Meetup 之行</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sketch-plugin-upload">Sketch 插件实现图层导出图片并上传</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ui-diff-in-out">国内外组件库的一些差异</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/thinking-recently">对近期一些事情的看法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/shijing">我读了读诗经</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gradient-in-fe">聊聊前端里的渐变</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/fabritor-2024-1">fabritor @ 2024 的一些更新</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023-summary">2023 总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-13-cline-source-code-prompt.md">Cline 源码浅析 - Prompt 设计</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-13T00:00:00.000Z">2025年6月13日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<p>“Agent 就是如何拼出更好用的 Prompt”，虽然有点玩笑的意味，但也能说明一定的问题。本篇文章我们探讨下 Cline 里的 Prompt 设计。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="system-prompt">System Prompt<a href="#system-prompt" class="hash-link" aria-label="System Prompt的直接链接" title="System Prompt的直接链接">​</a></h2>
<p>众所周知，System Prompt 是 Agent 的核  心资产😂，Github 上 <a href="https://github.com/x1xhlol/system-prompts-and-models-of-ai-tools" target="_blank" rel="noopener noreferrer">system-prompts-and-models-of-ai-tools</a> 这个仓库收集了各类 AI 应用的 System Prompt，已经有 56.6K 的 Star 了，可见一斑。</p>
<p>Cline 的 System Prompt 位于 <code>src/core/prompts/system.ts</code>，根据上下文信息、工具以及模型信息动态生成。</p>
<blockquote>
<p>You are Cline, a highly skilled software engineer with extensive knowledge in many programming languages, frameworks, design patterns, and best practices.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="工具-tool-use">工具 TOOL USE<a href="#工具-tool-use" class="hash-link" aria-label="工具 TOOL USE的直接链接" title="工具 TOOL USE的直接链接">​</a></h3>
<blockquote>
<p>You have access to a set of tools that are executed upon the user&#x27;s approval. You can use one tool per message, and will receive the result of that tool use in the user&#x27;s response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.</p>
</blockquote>
<p>我们自上而下的读一遍 System Prompt。</p>
<ol>
<li>工具调用格式</li>
</ol>
<p>首先告诉模型使用 XML 语法输出工具调用相关的内容。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">parameter1_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">value1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">parameter1_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">parameter2_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">value2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">parameter2_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>工具列表</li>
</ol>
<p>列举了 Cline 内置的工具，主要包括描述、参数以及使用 DEMO，比如 <code>write_to_file</code>：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> write_to_file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: Request to write content to a file at the specified path. If the file exists, it will be overwritten with the provided content. If the file doesn&#x27;t exist, it will be created. This tool will automatically create any directories needed to write the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> path: (required) The path of the file to write to (relative to the current working directory ${cwd.toPosix()})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> content: (required) The content to write to the file. ALWAYS provide the COMPLETE intended content of the file, without any truncation or omissions. You MUST include ALL parts of the file, even if they haven&#x27;t been modified.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">write_to_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">File path here</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your file content here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">write_to_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代 码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cline 内置了十多个工具，覆盖了命令行、文件操作、浏览器、MCP 等，这些工具极大的丰富了模型的能力。</p>
<ol start="3">
<li>工具调用 Example</li>
</ol>
<p>展示了多个工具调用的样例给模型参考：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">#</span><span class="token title important"> Tool Use Examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> Example 1: Requesting to execute a command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">execute_command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">npm run dev</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">requires_approval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">requires_approval</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">execute_command</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>工具使用指引</li>
</ol>
<p>这里相当于手把手教模型逐步思考如何使用工具（类似于思维链（CoT）），简单翻译如下：
1）首先，模型需要评估已经掌握的信息，使用 <code>&lt;thinking&gt;</code> 标签包裹。
2）根据任务和提供的工具描述，选择最合适的工具。
3）如果需要执行多个操作，请一次只使用一个工具，每一步都必须以前一步的结果为依据。
4）使用指定的 XML 格式来构建你的工具调用。
5）每次使用工具后，用户将回复该工具的执行结果。这个结果会为你提供继续任务或做出进一步决策所需的信息。
6）每次使用工具后，一定要等待用户的确认后再继续。</p>
<p>以上的操作，可以确保模型按步骤拆解任务，确认每步的成功与否，根据用户的反馈实时进行调整，保证工具使用和最终任务的正确性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mcp-server">MCP Server<a href="#mcp-server" class="hash-link" aria-label="MCP Server的直接链接" title="MCP Server的直接链接">​</a></h3>
<p>这部分我们在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDA0MTE5Mw==&amp;mid=2247483942&amp;idx=1&amp;sn=70ad8830317f688b79d800c39b80a62d&amp;chksm=9b572020ac20a936dcd5606ed29690f3c2d4856b39a0e9193c52f64896d47e4bd064e9e4fc7d&amp;scene=178&amp;cur_album_id=4021745110793502724&amp;search_click_id=#rd" target="_blank" rel="noopener noreferrer">Cline 源码浅析 - MCP 调用</a>聊过，这里不再展开。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件编辑-editing-files">文件编辑 EDITING FILES<a href="#文件编辑-editing-files" class="hash-link" aria-label="文件编辑 EDITING FILES的直接链接" title="文件编辑 EDITING FILES的直接链接">​</a></h3>
<p>对于 Code Agent 文件编辑是非常重要的部分，这里再次强调了 <code>write_to_file</code> 和 <code>replace_in_file</code> 两个工具的使用：详细的使用时机以及重要提示。</p>
<p>再次以 workflow 的方式告诉模型使用文件编辑工具的最佳实践：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> 在进行编辑之前，评估你更改的范围，并决定使用哪个工具。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 对于有针对性的修改，请使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 工具，并精心编写 SEARCH/REPLACE 块。如果你需要进行多项更改，可以在一个 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 调用中堆叠多个 SEARCH/REPLACE 块。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 对于大规模重构或初始文件创建，请依赖 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 工具。  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 一旦文 件通过 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 或 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 被编辑，系统将向你提供修改后文件的最终状态。请将此更新后的内容作为后续所有 SEARCH/REPLACE 操作的参考点，因为它反映了任何自动格式化或用户手动应用的更改。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">通过在 </span><span class="token code-snippet code keyword" style="color:#00009f">`write_to_file`</span><span class="token plain"> 和 </span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain"> 之间做出深思熟虑的选择，你可以使文件编辑过程更加顺畅、安全和高效。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="act-mode-和-plan-mode">Act Mode 和 Plan Mode<a href="#act-mode-和-plan-mode" class="hash-link" aria-label="Act Mode 和 Plan Mode的直接链接" title="Act Mode 和 Plan Mode的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/11/1749631375428-9af1e1b3-f2d1-44bd-991e-c15f14b7cf96.png" alt="" class="img_ev3q"></p>
<p>Cline 提供了两种模式：Plan 和 Act。对于复杂任务，Cline 推荐从 Plan 模式开始，让模型先行规划策略，然后切换到 Act 模式，按照规划逐步实施，以提高代码输出质量。对话过程中，可以在两个模式中切换，就像人一样，写代码过程中，遇到问题，停下来思考。</p>
<p>System Prompt 里详细描述了两种模式的差异，重点描述了一下 Plan 模式的规则，比如使用 <code>read_file</code> <code>search_files</code> 等工具了解信息，特别推荐使用图表直观展示信息，并强调 Plan 模式下会使用 <code>plan_mode_respond</code> 工具回复信息。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="功能-capabilities">功能 CAPABILITIES<a href="#功能-capabilities" class="hash-link" aria-label="功能 CAPABILITIES的直接链接" title="功能 CAPABILITIES的直接链接">​</a></h3>
<p>这一大段相当于把上面的工具集进行了一次总结，告诉模型有用哪些能力，可以使用哪些特定工具来完成特定的功能，比如命令行：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">You can use the execute_command tool to run commands on the user&#x27;s computer whenever you feel it can help accomplish the user&#x27;s task. When you need to execute a CLI command, you must provide a clear explanation of what the command does. ......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="规则-rules">规则 RULES<a href="#规则-rules" class="hash-link" aria-label="规则 RULES的直接链接" title="规则 RULES的直接链接">​</a></h3>
<p>规则部分主要强调了什么可以做，什么不能做。比如不可以使用 ~ 或 $HOME 来表示用户的主目录，不可以使用 cd 命令，不能口语化，必须等待用户确认。这里使用了大量的<code>** **</code> 加粗的标记提醒模型。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="系统信息">系统信息<a href="#系统信息" class="hash-link" aria-label="系统信息的直接链接" title="系统信息的直接链接">​</a></h3>
<p>获取系统信息，这些可以帮助命令行工具、文本读写工具的执行。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Operating System</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">osName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Default Shell</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">getShell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Home Directory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">homedir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPosix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current Working Directory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cwd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toPosix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="目标">目标<a href="#目标" class="hash-link" aria-label="目标的直接链接" title="目标的直接链接">​</a></h3>
<p>这里奠定了 Cline 处理问题的基调，我完整的贴在这里：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">你通过迭代的方式完成给定的任务，将其分解为清晰的步骤，并有条不紊地逐一执行。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">分析用户的任务</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，设定明确且可实现的目标以完成它。按逻辑顺序对这些目标进行优先级排序。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> 依次处理这些目标，在必要时一次使用一个可用工具。每个目标应对应你解决问题过程中的一个具体步骤。在整个过程中，你会被告知已完成的工作和剩余的任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> 请记住，你拥有广泛的工具能力，可以灵活、巧妙地运用这些工具来完成每一个目标。在调用任何工具之前，请在 </span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;thinking&gt;&lt;/thinking&gt;`</span><span class="token plain"> 标签中进行分析：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 首先，分析 </span><span class="token code-snippet code keyword" style="color:#00009f">`environment_details`</span><span class="token plain"> 中提供的文件结构，以获取上下文和洞察，从而有效地推进任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 然后，思考哪个可用工具最相关，能够帮助你完成用户任务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 接着，逐个检查该工具所需的参数，并判断用户是否已直接提供或提供了足够的信息用于推断参数值。在决定能否推断某个参数值时，请 仔细考虑所有上下文，看是否支持特定的取值。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> 如果所有必需的参数都已存在或可以合理推断，则关闭 </span><span class="token code-snippet code keyword" style="color:#00009f">`&lt;thinking&gt;`</span><span class="token plain"> 标签并继续执行工具操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">但如果有一个必需参数的值缺失</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要调用该工具</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">（即使填入占位符也不行），而是使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`ask_followup_question`</span><span class="token plain"> 工具向用户请求缺失的参数。如果未提供的是</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">可选参数</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，则</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要主动询问</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> 完成用户的任务后，你必须使用 </span><span class="token code-snippet code keyword" style="color:#00009f">`attempt_completion`</span><span class="token plain"> 工具将结果提交给用户。你也可以提供一条 CLI 命令来展示任务的结果；这对于 Web 开发任务尤其有用，例如你可以运行 </span><span class="token code-snippet code keyword" style="color:#00009f">`open index.html`</span><span class="token plain"> 来展示你构建的网站。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">5.</span><span class="token plain"> 用户可能会提供反馈，你可以根据反馈进行改进并重新尝试。但</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要陷入无意义的来回对话中</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">，也就是说，</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">不要以问题或提供进一步帮助的提议结束你的回复</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain">。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义-system-prompt">自定义 System Prompt<a href="#自定义-system-prompt" class="hash-link" aria-label="自定义 System Prompt的直接链接" title="自定义 System Prompt的直接链接">​</a></h3>
<p>在 <code>addUserInstructions</code> 方法中，追加用户自定义的指令，这里包括了 <a href="https://docs.cline.bot/features/cline-rules" target="_blank" rel="noopener noreferrer">Cline Rules</a>。我们可以在项目根目录下新建 <code>.clinerules/</code> 存放 Cline Rule，Cline 作为 System Prompt 最有效的补充，可以针对不同的项目做不同的定制。</p>
<p>甚至追加了 Cursor 或者 Windsurf 的 Rule。😂</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localCursorRulesFileInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localCursorRulesFileInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localCursorRulesDirInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localCursorRulesDirInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localWindsurfRulesFileInstructions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> localWindsurfRulesFileInstructions </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="claude4-支持">Claude4 支持<a href="#claude4-支持" class="hash-link" aria-label="Claude4 支持的直接链接" title="Claude4 支持的直接链接">​</a></h3>
<p>Cline 3.17.9 版本对 Claude4 做了特殊支持 <code>src/core/prompts/model_prompts/claude4.ts</code> 以及 <code>src/core/prompts/model_prompts/claude4-experimental.ts</code>。据官方博客描述，在使用新的 Claude4 模型时，会遇到一些编辑错误。</p>
<blockquote>
<p>这次版本更新主要关注 Cline 与 Claude 4 之间的交互，尤其是在搜索和替换操作上。我们调整了分隔符方法，将 &lt; 和 &gt; 替换为 - 和 + ，这在我们的内部测试中显示出了积极的效果，减少了编辑失败，提高了代码修改的成功率。</p>
</blockquote>
<p>这也给我们带来了一些提示：在模型切换时，需要及时的测试和调整 Prompt，以更好的适应更新更强大的模型。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="command-和-workflow">Command 和 Workflow<a href="#command-和-workflow" class="hash-link" aria-label="Command 和 Workflow的直接链接" title="Command 和 Workflow的直接链接">​</a></h2>
<p>除了 Cline Rules，Cline 还提供了其他方式来让用户定制 Prompt。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="slash-command">Slash Command<a href="#slash-command" class="hash-link" aria-label="Slash Command的直接链接" title="Slash Command的直接链接">​</a></h3>
<p>Cline 提供了 Slash Command 的概念，通过 <code>/</code> 触发。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/06/11/1749635423130-0b111dc0-9024-4a6f-bdab-9ece17bf3e45.png" alt="" class="img_ev3q"></p>
<p>不像 Cline Rule 会针对每个任务生效，Command 在实现特定类型任务的时候很有用。比如我们要反馈 Bug，就可以使用内置的 <code>/reportBug</code> 触发任务。而比如在执行其他任务，比如写代码时，不带上这个命令，也就不会发送相应的提示词给模型。</p>
<p>Command 相应的提示词位于 <code>src/core/prompts/commands.ts</code>，提示词组装过程中，会调用 <code>src/core/slash-commands/index.ts</code> 文件的 <code>parseSlashCommands</code>  方法，将 <code>/</code> 命令替换为指定的提示词。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow">Workflow<a href="#workflow" class="hash-link" aria-label="Workflow的直接链接" title="Workflow的直接链接">​</a></h3>
<p>如果要自定义 Command，除了源码层面定制，Cline 也支持用户手动配置，Cline 称其为 Workflow，Workflow 允许用户自定义步骤来处理特定的任务。在 <code>.clinerules</code> 目录下新建 <code>workflows</code> 目录，目录下新建 markdown 文件，文件内容我处理特定任务的步骤。这时候聊天框中输入 <code>/</code>，就会发现命令列表多了我们定制的 <code>/[workflow-name.md]</code>。</p>
<p>这部分逻辑依然在 <code>parseSlashCommands</code> 方法内，Command 和 Workflow 都会处理成 <code>/</code> 命令。</p>
<p>可以参照 Cline 仓库的 <code>.clinerules/workflows/pr-review.md</code> 编写自己的 Workflow。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mention-">Mention @<a href="#mention-" class="hash-link" aria-label="Mention @的直接链接" title="Mention @的直接链接">​</a></h2>
<p>@ 在 Cline 中是作为引用外部资源扩展上下文存在的。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img11@main/2025/06/11/1749649934154-2a274dec-1ff4-4c14-8e42-4e1a84366bc3.png" alt="" class="img_ev3q"></p>
<p>比如你可以 @ 一个文件路径，那这个文件的内容就会作为 Prompt 带给大模型。格式如下：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">file_content</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">path</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">path/to/file</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Complete file content]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">file_content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了文件，还可以 @ 问题、命令行甚至是一个 url，不必输入大段文字即可提供给模型更丰富的上下文信息。</p>
<p>mention 相关处理位于 <code>src/core/mentions/index.ts</code>，处理了各种 @ 信息。实践中，我们可以扩展 @能力，比如 @我们内部的知识库来让 Cline 更好的了解团队内部知识。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memery-bank">Memery Bank<a href="#memery-bank" class="hash-link" aria-label="Memery Bank的直接链接" title="Memery Bank的直接链接">​</a></h2>
<p>Memery Bank 是 Cline Agent 记忆系统的一个解决方案，[Cline Blog] 将 Memery Bank 比喻为笔记本，随着项目的更新持续的更新笔记，这样在开始新任务丢失历史记录和上下文的情况下，Cline 依旧可以通过笔记本里的内容了解项目全貌、技术架构以及当前进度等信息。</p>
<p>我们可以在 <code>.clinerules</code> 目录下新建 <code>memory-bank.md</code>，内容可以参照官方文档给出的<a href="https://docs.cline.bot/prompting/cline-memory-bank" target="_blank" rel="noopener noreferrer">示例</a>。</p>
<p>这份示例要求模型以如下的文档关系整理笔记本：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/06/12/1749734819909-17e56603-1947-4c2c-acac-4ec4a589f638.png" alt="" class="img_ev3q"></p>
<p>这六个文件分别作用为：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">projectbrief.md: 项目简介，奠定一切的基础文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">productContext.md: 产品上下文，商业和用户视角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemPatterns.md: 技术架构与决策</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">techContext.md: 开发环境和技术栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activeContext.md: 当前开发状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">progress.md: 项目进度与跟踪</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际工作中，工作前需要确认 Memory Bank 文件，获取必要的上下文知识，如果项目有重大更新，则更新相关文档，以应对上下文丢失的情况。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img15@main/2025/06/12/1749735115693-dbaf9940-685d-4e0f-8842-0a56c94c845e.png" alt="" class="img_ev3q"></p>
<p>在 Memory Bank 中，Cline 提倡以 Mermaid 图表作为 Prompt，Cline 团队认为：</p>
<blockquote>
<p>与 AI 交流的最佳方式并非自然语言——而是工作流的结构化语言。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>Cline 的 Prompt 非常有<strong>模块化</strong>的设计思想。Cline 将 Prompt 划分为 System Prompt、Command、Workflow、Mention、Memery 等模块，System Prompt 则划分为工具、MCP、目标、Mode 等模块，针对全局、特定或者全新的任务使用不同的 Prompt 来解决。</p>
<p>同时我们也发现 Cline 事无巨细，非常“啰嗦”，比如 System Prompt 关于工具调用格式就出现了好几次；尽可能多的提供上下文，这让 Cline 非常的消耗 Token。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/05/30/1748572666434-e20a0717-a388-47c9-8332-832423e6b337.png" alt="openrouter 网站的统计，Cline 遥遥领先" class="img_ev3q"></p>
<p>如何写出好用的 Prompt，个人感觉主要是两点：</p>
<ol>
<li>足够的上下文和示例（身份、目标、工具、示例等等）</li>
<li>足够详细和明确的执行步骤（Workflow）</li>
</ol>
<p>最后，可以查看官方文档<a href="https://docs.cline.bot/prompting/prompt-engineering-guide" target="_blank" rel="noopener noreferrer">提示词工程指南</a>进一步了解如何为 Cline 写出更好用的 Prompt。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-10-cline-source-code-mcp.md">Cline 源码浅析 - MCP 调用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-10T00:00:00.000Z">2025年6月10日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>上一篇文章<a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">Cline 源码浅析 - 从输入到输出</a>，从源码角度浏览了一下 Cline 处理用户输入到最后输出的过程，本文看一下其中关于 MCP 的处理。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<blockquote>
<p>关于 MCP，可以查看<a href="https://modelcontextprotocol.io/introduction" target="_blank" rel="noopener noreferrer">官方文档</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cline-mcp">Cline MCP<a href="#cline-mcp" class="hash-link" aria-label="Cline MCP的直接链接" title="Cline MCP的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何配置-mcp-server">如何配置 MCP Server<a href="#如何配置-mcp-server" class="hash-link" aria-label="如何配置 MCP Server的直接链接" title="如何配置 MCP Server的直接链接">​</a></h3>
<p>我们打开 Cline 的 MCP 界面，可以看到 Cline 提供了多种配置 MCP 的方式：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img14@main/2025/06/09/1749464726040-18f47f48-723f-41ee-9d7f-59d2f65144e5.png" alt="" class="img_ev3q"></p>
<p>本质上都是将 MCP 配置写入设置目录下的 <code>cline_mcp_settings.json</code> 文件，这里我们配置一个根据姓名查询工号的 MCP Server。</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;mcpServers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name2empid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;autoApprove&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;disabled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;timeout&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;url&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://xxxx.com/xxx/sse&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sse&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>另外 Cline 自行维护了一个 MCP 市场，用户可以从中选择安装，Cline 提供了一个比较有意思的安装方式，当你点击 Install 的时候，他并不是简单的把配置写入配置文件，而是通过大模型来进行安装（从访问文档到安装到验证），代码位于 <code>src/core/controller/mcp/downloadMcp.ts</code>，提示词如下：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Create task with context from README and added guidelines for MCP server installation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Set up the MCP server from </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">githubUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> while adhering to these MCP server installation rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Start by loading the MCP documentation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Use &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">mcpId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&quot; as the server name in cline_mcp_settings.json.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Create the directory for the new MCP server before starting installation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Make sure you read the user&#x27;s existing cline_mcp_settings.json file before editing it with this new mcp, to not overwrite any existing servers.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Use commands aligned with the user&#x27;s shell and operating system best practices.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- The following README may contain instructions that conflict with the user&#x27;s OS, in which case proceed thoughtfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Once installed, demonstrate the server&#x27;s capabilities by using one of its tools.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">Here is the project&#x27;s README to help you get started:\n\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">readmeContent</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">mcpDetails</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">llmsInstallationContent</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="源码阅读">源码阅读<a href="#源码阅读" class="hash-link" aria-label="源码阅读的直接链接" title="源码阅读的直接链接">​</a></h3>
<p>MCP 配置相关的代码位于：<code>src/services/mcp/McpHub.ts</code>，这里本质就是一个 MCP Client 初始化的逻辑，根据配置连接 Server 获取 Tool。</p>
<p>连接的 Server 的代码位于 <code>connectToServer</code>，调用 <code>@modelcontextprotocol/sdk/client</code> 这个包初始化 Client。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cline&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clientVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capabilities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 处理不同的类型的 Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StdioClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SSEClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StreamableHTTPClientTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后获取 tool 和 resource：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Initial fetch of tools and resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tools </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchToolsList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchResourcesList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceTemplates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fetchResourceTemplatesList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>MCP Client 的工作初始化完成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mcp-的使用">MCP 的使用<a href="#mcp-的使用" class="hash-link" aria-label="MCP 的使用的直接链接" title="MCP 的使用的直接链接">​</a></h2>
<p>下面看一下我们配置好的 MCP Server 是如何在我们的任务中运作的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="system-prompt">System Prompt<a href="#system-prompt" class="hash-link" aria-label="System Prompt的直接链接" title="System Prompt的直接链接">​</a></h3>
<p><a href="https://mp.weixin.qq.com/s/9bJAeQ3U0_U85sDCcJSXxw" target="_blank" rel="noopener noreferrer">上一篇文章</a>我们得知，System Prompt 是实时拼接的，这里把 MCP Server 相关的 Prompt 贴在这里：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> systemPrompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">MCP SERVERS</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">The Model Context Protocol (MCP) enables communication between the system and locally running MCP servers that provide additional tools and resources to extend your capabilities.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"># Connected MCP Servers</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">When a server is connected, you can use the server&#x27;s tools via the \`use_mcp_tool\` tool, and access the server&#x27;s resources via the \`access_mcp_resource\` tool.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">	mcpHub</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">getServers</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">length </span><span class="token template-string interpolation operator" style="color:#393A34">&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:#36acaa">0</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">		</span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> `$</span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation">mcpHub</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">getServers</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">filter</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">status </span><span class="token template-string interpolation operator" style="color:#393A34">===</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;connected&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> tools </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">tool</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">{</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">							</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> schemaStr </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> tool</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">inputSchema</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">								</span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">    Input Schema:</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation template-string string" style="color:#e3116c">    </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation constant" style="color:#36acaa">JSON</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">stringify</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">inputSchema</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">,</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation keyword" style="color:#00009f">null</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">,</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation number" style="color:#36acaa">2</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">split</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;\n    &quot;</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">								</span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">							</span><span class="token template-string interpolation keyword" style="color:#00009f">return</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">: </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tool</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">schemaStr</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> templates </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">resourceTemplates</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">template</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">uriTemplate</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">): </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">template</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> resources </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation function" style="color:#d73a49">map</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">resource</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">=&gt;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">- </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">uri</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">): </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resource</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">description</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation string" style="color:#e3116c">&quot;\n&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">const</span><span class="token template-string interpolation"> config </span><span class="token template-string interpolation operator" style="color:#393A34">=</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation constant" style="color:#36acaa">JSON</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation function" style="color:#d73a49">parse</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">server</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">config</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation keyword" style="color:#00009f">return</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">## </span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">server</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">name</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c"> (\`</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">command</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">args </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">&amp;&amp;</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation builtin">Array</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation function" style="color:#d73a49">isArray</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation">args</span><span class="token template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string interpolation template-string string" style="color:#e3116c"> </span><span class="token template-string interpolation template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation template-string interpolation">config</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation template-string interpolation">args</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation template-string interpolation template-string interpolation function" style="color:#d73a49">join</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation template-string interpolation template-string interpolation string" style="color:#e3116c">&quot; &quot;</span><span class="token template-string interpolation template-string interpolation template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation template-string interpolation"> </span><span class="token template-string interpolation template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\`)</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">tools </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Available Tools\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">tools</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">templates </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Resource Templates\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">templates</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">+</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">						</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">resources </span><span class="token template-string interpolation operator" style="color:#393A34">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation template-string string" style="color:#e3116c">\n\n### Direct Resources\n</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation template-string interpolation">resources</span><span class="token template-string interpolation template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string interpolation template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#393A34">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#e3116c">&quot;&quot;</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">					</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string interpolation">				</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">				.join(&quot;\n\n&quot;)}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;(No MCP servers currently connected)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>MCP Server 的相关提示词在 System Prompt  Tool Use Guidelines 部分，通过遍历 McpHub 内所有 server，将 server 内的 tool 格式化的拼接到 Prompt 中。大致格式为：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> name2empid(node xxx.ts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token title important punctuation" style="color:#393A34">###</span><span class="token title important"> Available Tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> get_empid_by_name: 根据员工姓名查询工号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	Input Schema: {&quot;name&quot;: &quot;string&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同时还提供给模型一个调用 MCP Server Tool 的示例：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> Example 5: Requesting to use an MCP tool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">weather-server</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">get_forecast</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;city&quot;: &quot;San Francisco&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;days&quot;: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>涉及到 MCP 调用统一使用 <code>use_mcp_tool</code> 工具，然后再指定是哪个 MCP 工具。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模型调用">模型调用<a href="#模型调用" class="hash-link" aria-label="模型调用的直接链接" title="模型调用的直接链接">​</a></h3>
<p>比如我们问“查询张三的工号”，模型输出类似下面这样：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我需要查询&quot;张三&quot;的工号。根据任务描述，我需要使用name2empid MCP服务器提供的工具来获取员工的工号。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我可以使用</span><span class="token code-snippet code keyword" style="color:#00009f">`use_mcp_tool`</span><span class="token plain">工具来调用name2empid服务器的</span><span class="token code-snippet code keyword" style="color:#00009f">`get_empid_by_name`</span><span class="token plain">工具，该工具可以根据员工姓名获取工号。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">需要的参数是:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> server_name: &quot;name2empid&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> tool_name: &quot;get_empid_by_name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> arguments: 包含员工姓名的JSON对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">我已经有了所有必要的信息，可以直接调用这个工具。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">name2empid</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">server_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">get_empid_by_name</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">tool_name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;张三&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">arguments</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">use_mcp_tool</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>经过 <code>parseAssistantMessageV2</code> 和 <code>presentAssistantMessage</code>  两个方法，会从模型输出中解析出使用的 MCP Tool 以及参数，和内置的 Tool 逻辑基本类似。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;use_mcp_tool&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">server_name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;name2empid&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tool_name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;get_empid_by_name&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{\n  &quot;name&quot;: &quot;张三&quot;\n}&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arguments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{\n  &quot;name&quot;: &quot;张三&quot;\n}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;name2empid&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tool_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;get_empid_by_name&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时，Cline 会执行 McpHub 内的 <code>callTool</code> 方法获取结果，后面再将结果交给模型，得到最终输出，自此任务结束。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>如果觉得 Cline 源  码太复杂，可以直接看 <a href="https://modelcontextprotocol.io/quickstart/client#node" target="_blank" rel="noopener noreferrer">MCP 官方的 Client DEMO</a>，比较清晰。</p>
<p>MCP 大大扩展了模型能力，可以在让模型发挥更好的价值。Cline 在 MCP 的管理和调用上设计的都很巧妙，尤其是 System Prompt，下一篇文章我们将探讨一下 Cline 的 Prompt 设计。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-06-07-cline-source-code-1.md">Cline 源码浅析 - 从输入到输出</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-07T00:00:00.000Z">2025年6月7日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/06/06/1749176746221-f97aba25-6da5-461a-be21-369de1c44fff.png" alt="" class="img_ev3q"></p>
<p>我们在上一篇文章：<a href="https://mp.weixin.qq.com/s/EkGEk3UrZvxIH2VV0DWdLA" target="_blank" rel="noopener noreferrer">现在开始使用 Cline Rules</a> 里简单介绍过 Cline，本篇文章从源码角度来看一下从我们输入指令到 Cline 输出的过程到底是怎样的，这样对我们后续使用 Cline 会有更好的帮助。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动-cline">启动 Cline<a href="#启动-cline" class="hash-link" aria-label="启动 Cline的直接链接" title="启动 Cline的直接链接">​</a></h2>
<p>访问 Cline 的 Github 仓库 README：<a href="https://github.com/cline/cline?tab=readme-ov-file#contributing%EF%BC%9A" target="_blank" rel="noopener noreferrer">https://github.com/cline/cline?tab=readme-ov-file#contributing：</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/cline/cline.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code cline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm run install:all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 VSCode 里 <code>F5</code> 或者 <code>Run-&gt;Start Debugging</code> 开始调试 Cline VSCode 插件。此时会新开一个 VSCode 窗口，这个窗口里我们可以愉快的调试 VSCode。</p>
<blockquote>
<p>这里可能遇到一些问题，一个是仓库里提到的，如果构建有问题，需要安装 <a href="https://marketplace.visualstudio.com/items?itemName=connor4312.esbuild-problem-matchers" target="_blank" rel="noopener noreferrer">esbuild Problem Matchers插件</a>；另外项目的 Webview 里需要安装 electron 这个巨无霸，可能会很慢，可以设置为国内源：</p>
</blockquote>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">electron_mirror=https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//npmmirror.com/mirrors/electron/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">electron_builder_binaries_mirror=https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//npmmirror.com/mirrors/electron</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">binaries/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shamefully</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hoist=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-debug">Step by Step Debug<a href="#step-by-step-debug" class="hash-link" aria-label="Step by Step Debug的直接链接" title="Step by Step Debug的直接链接">​</a></h2>
<p>VSCode 对自家插件的调试做的非常好，不管是 VSCode 主进程还是 Webview 内容，下面就一步一步的开始调试。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="前端输入">前端输入<a href="#前端输入" class="hash-link" aria-label="前端输入的直接链接" title="前端输入的直接链接">​</a></h3>
<p>我们准备一段简单的输入：创建一个新任务，实现快速排序算法，并插入到 utils 文件内。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/newtask 实现快速排序算法，写入 @/src/utils/index.ts 文件</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>这里使用了 Cline 的内置的两个功能：内置命令 Command /newtask 以及 mention @ 功能指定了写入的文件。Command 可以理解为指定特定任务的 prompts，方便执行一些高频操作的任务，Cline 内置了诸如新建任务、创建 Rule、创建 Github Issue 等 Command。@ 功能可以指定模型特别关注的上下文，比如指定的文件内容，指定的目录内容。</p>
</blockquote>
<p>输入框内输入上述内容，点击发送，代码文件：<code>webview-ui/src/components/chat/ChatView.tsx</code>，发送消息的方法为 <code>handleSendMessage</code>，Webview 内只负责收集输入信息，实际任务处理的逻辑都会发送至 VSCode 的主进程内，VSCode 主进程处理过程中，会实时的发送消息回 Webview。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 文件位置 webview-ui/src/services/grpc-client-base.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;message&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handleResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Send the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> encodedRequest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">encodeRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vscode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;grpc_request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grpc_request</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fullName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// method 为 newTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> encodedRequest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// message 为输入的文本、图片、文件消息等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_streaming</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>message 的格式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">files =(0) []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images =(0) []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text =&#x27;/newtask 创建一个快速排序算法，写入 @/src/utils/index.ts 文件&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>VSCode 主进程接收 <code>grpc_request</code> 消息进行处理。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vscode-主进程接收消息">VSCode 主进程接收消息<a href="#vscode-主进程接收消息" class="hash-link" aria-label="VSCode 主进程接收消息的直接链接" title="VSCode 主进程接收消息的直接链接">​</a></h3>
<p>主进程处理的内容位于：<code>src/core/controller/grpc-handler.ts</code>：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * Handle a gRPC request from the webview</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">service</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The service name</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">method</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The method name</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">message</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The request message</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">requestId</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The request ID for response correlation</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@param</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> </span><span class="token doc-comment comment parameter" style="color:#999988;font-style:italic">isStreaming</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> Whether this is a streaming request</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 * </span><span class="token doc-comment comment keyword" style="color:#00009f;font-style:italic">@returns</span><span class="token doc-comment comment" style="color:#999988;font-style:italic"> The response message or error for unary requests, void for streaming requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">	 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		requestId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		isStreaming</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		message</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		error</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		request_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，参数和 Webview 传过来的一致。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="任务初始化">任务初始化<a href="#任务初始化" class="hash-link" aria-label="任务初始化的直接链接" title="任务初始化的直接链接">​</a></h3>
<p>经过各种封装，最终处理的任务落到了 <code>src/core/controller/index.ts</code> 的 <code>initTask</code> 方法内一个超级大的 Task 类的初始化：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpHub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">workspaceTracker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">historyItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateTaskHistory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">historyItem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postStateToWebview</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">postMessageToWebview</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reinitExistingTaskFromId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cancelTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiConfiguration</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  autoApprovalSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  browserSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chatSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shellIntegrationTimeout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terminalReuseEnabled </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableCheckpointsSetting </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customInstructions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  files</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  historyItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Task 类位于 <code>src/core/task/index.ts</code>，</p>
<p>在一系列的初始化后：</p>
<blockquote>
<p>初始化的代码没有过度深究，从类名来看，包括了后续任务执行中可能使用到的工具：浏览器、命令行、Url、DiffView 等；mcp 的配置；autoApproval 的配置等等。</p>
</blockquote>
<p>终于进入到实际的逻辑处理：</p>
<p>首先，根据用户配置的模型  提供商信息创建 AI 的 api handler：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Now that taskId is initialized, we can build the API handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">api </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildApiHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">effectiveApiConfiguration</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，进入到 <code>startTask</code> 方法：</p>
<p>say 方法会在聊天面板新增一条消息，比如下面的代码，将用户的输入信息显示在聊天面板：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img4@main/2025/06/06/1749196272451-b424c65b-cb65-411f-9cbb-92322d586b92.png" alt="" class="img_ev3q"></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">say</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> images</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="构建-user-prompt">构建 User Prompt<a href="#构建-user-prompt" class="hash-link" aria-label="构建 User Prompt的直接链接" title="构建 User Prompt的直接链接">​</a></h3>
<p>接下来，构建 userContent：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 为用户输入的消息添加一个 task 标签。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> userContent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UserContent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">&lt;task&gt;\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">task</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">\n&lt;/task&gt;</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">imageBlocks</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">输出：</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">text =</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">&#x27;&lt;task&gt;\n/newtask 创建一个快速排序算法，写入 @/src/utils/index.ts 文件\n&lt;/task&gt;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">type =</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">&#x27;text&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">*/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果用户提供了文件（Cline 支持用户上传文本文件），背后其实是读完文本文本，也用来构造 userContent。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">files </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fileContentString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processFilesIntoText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">files</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileContentString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> fileContentString</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="继续构造-prompts">继续构造 Prompts<a href="#继续构造-prompts" class="hash-link" aria-label="继续构造 Prompts的直接链接" title="继续构造 Prompts的直接链接">​</a></h3>
<p>用过 Cline 的话，我们会知道 Cline 会循环处理任务，所以 User Prompts 构造完成后，进入到 <code>initiateTaskLoop</code> 方法，真正执行任务的方法为 <code>recursivelyMakeClineRequests</code>：</p>
<p>进一步处理用户的输入信息：</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">parsedUserContent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environmentDetails</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clinerulesError</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">loadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userContent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> includeFileDetails</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样处理之后，用户输入重新组装为 parsedUserContent，内容比较长，这里不贴了，大致格式为：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">explicit_instructions</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">new_task</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">explicit_instructions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">task</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">用户输入</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">task</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">fileContent</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">src/utils/index.ts内的文件</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">fileContent</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>再次看一下我们的输入：<code>/newtask 实现快速排序算法，写入 @/src/utils/index.ts 文件</code>，上面三段一一对应：<code>\&lt;explicit_instructions type=&quot;new_task\&gt;&quot;</code> 对应 /newtask 命令，这是 Cline 的内置 prompt，@/src/utils/index.ts 添加了该文件内容作为上下文。</p>
<p>同时将 environmentDetails 也添加到 userContent，environmentDetails 有工作目录、当前时间、当前打开的 Tab 等。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">userContent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parsedUserContent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// add environment details as its own text block, separate from tool results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">userContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> environmentDetails </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>怪不得 Cline 这么耗 Token！</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模型请求">模型请求<a href="#模型请求" class="hash-link" aria-label="模型请求的直接链接" title="模型请求的直接链接">​</a></h3>
<p>继续进入 <code>attemptApiRequest</code> 方法，首先构造 System prompt：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> isClaude4ModelFamily </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isClaude4ModelFamily</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> systemPrompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SYSTEM_PROMPT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cwd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> supportsBrowserUse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpHub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">browserSettings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isClaude4ModelFamily</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比较有意思的是，Cline 针对 Claude4 定制了不同的 System Prompt。</p>
<blockquote>
<p>System Prompt 里会告诉模型我们当前已经提供了哪些工具以及这些工具该如何调用（参数和规则），比如本次任务要将模型生成的代码写入已有文件，那么就需要使用到 <code>replace_in_file</code>  这个工具，这里贴一下 System Prompt 里关于  <code>replace_in_file</code> 的内容。</p>
</blockquote>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token title important punctuation" style="color:#393A34">##</span><span class="token title important"> replace_in_file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description: Request to replace sections of content in an existing file using SEARCH/REPLACE blocks that define exact changes to specific parts of the file. This tool should be used when you need to make targeted changes to specific parts of a file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> path: (required) The path of the file to modify (relative to the current working directory ${cwd.toPosix()})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token list punctuation" style="color:#393A34">-</span><span class="token plain"> diff: (required) One or more SEARCH/REPLACE blocks following this exact format:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  \`\`\`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ------- SEARCH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [exact content to find]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  =======</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [new content to replace with]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  +++++++ REPLACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  \`\`\`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Critical rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">1.</span><span class="token plain"> SEARCH content must match the associated file section to find EXACTLY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Match character-for-character including whitespace, indentation, line endings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include all comments, docstrings, etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">2.</span><span class="token plain"> SEARCH/REPLACE blocks will ONLY replace the first match occurrence.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Including multiple unique SEARCH/REPLACE blocks if you need to make multiple changes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include </span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token italic content">just</span><span class="token italic punctuation" style="color:#393A34">*</span><span class="token plain"> enough lines in each SEARCH section to uniquely match each set of lines that need to change.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> When using multiple SEARCH/REPLACE blocks, list them in the order they appear in the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">3.</span><span class="token plain"> Keep SEARCH/REPLACE blocks concise:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Break large SEARCH/REPLACE blocks into a series of smaller blocks that each change a small portion of the file.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Include just the changing lines, and a few surrounding lines if needed for uniqueness.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Do not include long runs of unchanging lines in SEARCH/REPLACE blocks.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> Each line must be complete. Never truncate lines mid-way through as this can cause matching failures.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token list punctuation" style="color:#393A34">4.</span><span class="token plain"> Special operations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> To move code: Use two SEARCH/REPLACE blocks (one to delete from original + one to insert at new location)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token list punctuation" style="color:#393A34">*</span><span class="token plain"> To delete code: Use empty REPLACE section</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">File path here</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Search and replace blocks here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同时，System Prompt 也继续追加了用户的偏好语言，方便按照用户偏好的语言进行输出。</p>
<p>接下来发送请求：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">systemPrompt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contextManagementMetadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">truncatedConversationHistory</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>针对模型的输出，需要进一步处理，是直接展示在聊天面板，还是需要调用工具处理，这部分逻辑在 <code>src/core/assistant-message/parse-assistant-message.ts</code> 的 <code>parseAssistantMessageV2</code> 方法内。</p>
<p>针对我们本次创建排序算法的任务，下面是一个模型输出样例：</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n我需要在</span><span class="token code-snippet code keyword" style="color:#00009f">`src/utils/index.ts`</span><span class="token plain">文件中添加一个快速排序算法。首先，我已经看到了文件的内容，这是一个工具函数集合文件，包含了各种实用函数，如rpx转换、vw计算、类型检查、日志记录等。\n\n我需要在这个文件中添加一个快速排序算法实现。快速排序是一种高效的排序算法，基于分治法的思想。我将实现一个通用的快速排序函数，可以对数组进行排序。\n\n我将使用</span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain">工具来修改文件，在文件末尾添加快速排序算法的实现。我需要确保添加的代码与现有代码风格保持一致，并提供适当的类型注解和注释。\n\n我将在文件末尾添加快速排序算法的实现，包括：\n1. 一个主快速排序函数，接受一个数组和可选的比较函数\n2. 一个辅助函数用于分区操作\n\n让我使用</span><span class="token code-snippet code keyword" style="color:#00009f">`replace_in_file`</span><span class="token plain">工具来修改文件。\n</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">thinking</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">replace_in_file</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">src/utils/index.ts</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">path</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">diff</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">\n------- SEARCH\nexport const jump2UpdateApp = () =&gt; {\n  if (is… (a, b) =&gt; {\n  if (a &lt; b) return -1;\n  if (a &gt; b) return 1;\n  return 0;\n}): T[] =&gt; {\n  // 创建数组副本，不修改原数组\n  const result = [...arr];\n  \n  // 内部快速排序实现\n  const _quickSort = (arr: T[], left: number, right: number) =&gt; {\n    if (left &lt; right) {\n      const pivotIndex = partition(arr, left, right);\n      _quickSort(arr, left, pivotIndex - 1);\n      _quickSort(arr, pivotIndex + 1, right);\n    }\n  };\n  \n  // 分区操作\n  const partition = (arr: T[], left: number, right: number): number =&gt; {\n    // 选择最右边的元素作为基</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>parseAssistantMessageV2</code> 方法会解析上述输出内容，主要是从模型输出中解析出使用哪些工具以及工具  的参数，比如这里我们发现模型输出中有 &lt;replace_in_file&gt;，那就说明这次需要使用 replace_in_file 工具。</p>
<p>接下来调用 <code>presentAssistantMessage</code> 方法真正将模型消息展示给用户，一方面展示文本消息，类似下图：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img9@main/2025/06/06/1749217048970-dba8c0b7-c03c-4767-a014-845c105ab0d9.png" alt="" class="img_ev3q"></p>
<p>一方面执行上一步解析出的 tool，将模型生成代码以 diff 的方式写入文件，这里借助 VSCode 的能力创建 diffView。自此这个任务算是完成了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>抛开 Cline 中用户交互和工程处理的部分，我们发现最核心的其实只有两件事情：</p>
<ol>
<li>
<p>prompt 组装。这其中包括了 System Prompt、VSCode 和系统的环境信息、内置 Command、内置的 @ 引用（文件、目录信息）、用户的输入（文本、图片、文本文件），当然还有我们之前介绍的 Rules 以及我们提到过的 Workflow（本质是用户自定义的 Command）。这些内容共同组装称为 Prompt 发送给模型，力求给模型足够多的上下文信息，获得更加准确的结果。</p>
</li>
<li>
<p>tools 调用。首先在 System Prompt 定义了模型可以调用的 Tool（包括内置的和 MCP Server 定义的），在模型输出时指定调用的 Tool 和需要的参数，以此斤进一步增强模型的能力。</p>
</li>
</ol>
<p>两者共同合作完成用户的编码的任务。</p>
<p>由此我们可以看到 Agent 开发中最重要的三点：</p>
<ol>
<li>模型的使用</li>
<li>丰富的创意</li>
<li>丝滑的体验</li>
</ol>
<p>最后，本文是在我边调试边写作的过程中完成的，可能表达还不够清晰，欢迎有兴趣的同学一起交流指正 。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-05-30-cline-rule.md">现在开始使用 Cline Rules</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-30T00:00:00.000Z">2025年5月30日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/05/30/1748588412574-e064741c-0bf1-4c61-be3c-fd9ac86453e4.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="写在前面">写在前面<a href="#写在前面" class="hash-link" aria-label="写在前面的直接链接" title="写在前面的直接链接">​</a></h3>
<p>最近在业务（面向用户的 C 端业务）中较多的使用了 <a href="https://docs.cline.bot/getting-started/what-is-cline" target="_blank" rel="noopener noreferrer">Cline</a>，总体感觉非常丝滑（尤其是看着他在默默地生成代码并且自己排查错误的时候，但 Token 确实也消耗的很快😂）。</p>
<p>Cline 算是 VS Code AI 开发插件中的佼佼者了，并且是一个开源项目，他的一个 fork 分支 RooCode 热度也很高。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/05/30/1748572666434-e20a0717-a388-47c9-8332-832423e6b337.png" alt="openrouter 网站的统计，Cline 遥遥领先" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开始配置-cline-rules">开始配置 Cline Rules<a href="#开始配置-cline-rules" class="hash-link" aria-label="开始配置 Cline Rules的直接链接" title="开始配置 Cline Rules的直接链接">​</a></h3>
<p>作为一个通用的编程助手，如何能针对不同的项目进行更好的开发，除了 Cline 本身对代码的理解之外，作为用户如果能提供更多的指引，可以让 Cline 发挥更好的作用。</p>
<p>一般来说，Cline、Cursor 及其他代码 Agent 都会提供 rules 这个概念，在项目根目录下新建 rules 目录，目录下根据自己的项目可以新建各种规则文件。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">your-project/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── .clinerules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		├── project.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── api.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	├── docs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	└── ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你的规则全局通用，可以将规则放置到 <code>Documents/Cline/Rules</code> 目录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cline-rules-优势">Cline Rules 优势<a href="#cline-rules-优势" class="hash-link" aria-label="Cline Rules 优势的直接链接" title="Cline Rules 优势的直接链接">​</a></h3>
<p>放在项目内好处很明显：</p>
<ol>
<li>可以针对每个项目配置不同的规则；</li>
<li>作为项目源代码的一部分，进行版本控制，持续维护，跟随项目发展设置长远的 rule；</li>
<li>保证团队成员使用 AI 的行为是一致的。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cline-rules-的原则">Cline Rules 的原则<a href="#cline-rules-的原则" class="hash-link" aria-label="Cline Rules 的原则的直接链接" title="Cline Rules 的原则的直接链接">​</a></h3>
<ol>
<li>清晰简洁：使用简单语言，避免歧 义。</li>
<li>关注期望结果：描述你想要的结果，而不是具体步骤。</li>
<li>测试和迭代：试验找出最适合你的工作流程的方法。</li>
</ol>
<p>rules 本质上是自定义 prompts，和 Cline 的 system prompts 互为补充，共同为项目服务。（system promps：<a href="https://github.com/cline/cline/blob/main/src/core/prompts/model_prompts/claude4.ts%EF%BC%89" target="_blank" rel="noopener noreferrer">https://github.com/cline/cline/blob/main/src/core/prompts/model_prompts/claude4.ts）</a></p>
<p>关于提示词，我之前有总结过<a href="https://mp.weixin.qq.com/s/YFV0MO_pX3Us-PEMzxF0vQ" target="_blank" rel="noopener noreferrer">谷歌的提示词最佳实践</a>，可以看一下。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高级用法-rules-bank">高级用法 Rules Bank<a href="#高级用法-rules-bank" class="hash-link" aria-label="高级用法 Rules Bank的直接链接" title="高级用法 Rules Bank的直接链接">​</a></h3>
<p>Rules Bank 顾名思义，就是存放 Rules 的地方，如果你的项目很复杂，又有前端、又有后端、又有不同的技术栈，这个时候就很有用。</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">your-project/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── .clinerules/              # Active rules - automatically applied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── 01-coding.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── client-a.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── clinerules-bank/          # Repository of available but inactive rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── clients/              # Client-specific rule sets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── client-a.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── client-b.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── frameworks/           # Framework-specific rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── react.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── vue.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── project-types/        # Project type standards</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── api-service.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── frontend-app.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比如当你在开发 React 技术栈的时候，从 Rules Bank 中复制 React Rule 到 Cline Rules 内。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Switch to React</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm .clinerules/vue.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp clinerules-bank/clients/react.md .clinerules/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总之一切文本放到代码仓库中，提高可持续性，并且可以跟随项目保持最新的迭代！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何管理">如何管理<a href="#如何管理" class="hash-link" aria-label="如何管理的直接链接" title="如何管理的直接链接">​</a></h3>
<p>Cline 提供了一种方便的方式管理 Rules，在输入框下方一个天平的小标志内，可以打开 Rule 管理器，新增删除或者启用禁用 Rule。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img19@main/2025/05/30/1748590113024-f84df6e2-374d-4378-b4af-79b8b7ed9f86.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="#最后" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h3>
<p>十分建议你在平时工作中使用 Cline，并使用 Cline Rule 增强开发体验。后面会持续更新 Cline 的相关内容。</p>
<p>最后，假期快乐！</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cline">Cline</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-30-ts-agent-mastra.md">Mastra  - TypeScript AI Agent 框架</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-21T00:00:00.000Z">2025年5月21日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 /  开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img10@main/2025/05/19/1747639233989-a54bfdd8-3570-4750-8b7c-c8f0b88ff435.png" alt="" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h2>
<p>之前我们讨论过<a href="https://mp.weixin.qq.com/s/9KaU4LeGmkw0YGmY-XRihw?token=2043170037&amp;lang=zh_CN" target="_blank" rel="noopener noreferrer">什么是 Agent</a>，都是一些概念性的闲聊，今天介绍的 <a href="https://mastra.ai/" target="_blank" rel="noopener noreferrer">Mastra</a>，是一个难得的（一般都是 Python 框架） TS 的 AI Agent 框架，可以让你快手上手开发一个 Agent，目前已经有 13.2K 的 Star。</p>
<p><strong>前端人狂喜</strong>。</p>
<p>Mastra 提供了 Agent 所需的所有要素：</p>
<ol>
<li>大模型：基于 Vercel AI SDK。</li>
<li>Tools：工具。</li>
<li>Workflow：工作流，以支持更加复杂的工作。</li>
<li>RAG：检索增强生成，以帮助构建知识库。</li>
<li>Memery：各种存储方式集成。</li>
<li>Agent：最终的 Agent 构建。</li>
</ol>
<p>接下来，我们按照官网的快速开始，在 Next.js 框架中接入 Mastra。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="快速开始">快速开始<a href="#快速开始" class="hash-link" aria-label="快速开始的直接链接" title="快速开始的直接链接">​</a></h2>
<ol>
<li>
<p>初始化 Next.js 结构，参照官网即可。</p>
</li>
<li>
<p>lib 目录下 新建 mastra 目录，在这个目录下开发 Agent 相关的内容。</p>
</li>
<li>
<p>新建 tools 目录，扩展大模型能力的工具，比如建一个根据城市获取天气的工具。tools 目录下新建 <code>weather-tool.ts</code> 文件。</p>
</li>
</ol>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> createTool </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@mastra/core/tools&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> z </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;zod&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">WeatherResponse</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  current</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temperature_2m</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apparent_temperature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relative_humidity_2m</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wind_speed_10m</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wind_gusts_10m</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weather_code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> weatherTool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;get-weather&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Get current weather for a location&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inputSchema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;City name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputSchema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temperature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    feelsLike</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    humidity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    windSpeed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    windGust</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">number</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">execute</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> context </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getWeather</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">location</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">getWeather</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">location</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geocodingUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">https://geocoding-api.open-meteo.com/v1/search?name=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation function" style="color:#d73a49">encodeURIComponent</span><span class="token template-string interpolation punctuation" style="color:#393A34">(</span><span class="token template-string interpolation">location</span><span class="token template-string interpolation punctuation" style="color:#393A34">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&amp;count=1</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geocodingResponse </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">geocodingUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> geocodingData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> geocodingResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">geocodingData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">results</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Location &#x27;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">location</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&#x27; not found</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> latitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> longitude</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> geocodingData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> weatherUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">https://api.open-meteo.com/v1/forecast?latitude=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">latitude</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&amp;longitude=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">longitude</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&amp;current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,wind_gusts_10m,weather_code</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">weatherUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> WeatherResponse </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temperature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">temperature_2m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    feelsLike</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">apparent_temperature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    humidity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relative_humidity_2m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    windSpeed</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wind_speed_10m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    windGust</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wind_gusts_10m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getWeatherCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weather_code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getWeatherCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Clear sky&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Mainly clear&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Partly cloudy&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Overcast&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">45</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Foggy&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">48</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Depositing rime fog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">51</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Light drizzle&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">53</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Moderate drizzle&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">55</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Dense drizzle&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">56</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Light freezing drizzle&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">57</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Dense freezing drizzle&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">61</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Slight rain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">63</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Moderate rain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">65</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Heavy rain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">66</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Light freezing rain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">67</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Heavy freezing rain&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">71</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Slight snow fall&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">73</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Moderate snow fall&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">75</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Heavy snow fall&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">77</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Snow grains&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Slight rain showers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">81</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Moderate rain showers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">82</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Violent rain showers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">85</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Slight snow showers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">86</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Heavy snow showers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">95</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Thunderstorm&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">96</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Thunderstorm with slight hail&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">99</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Thunderstorm with heavy hail&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> conditions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">code</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Unknown&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>mastra 目录下新建 agents 目录，agent 目录下新建 <code>weather-agent.ts</code> 文件。</li>
</ol>
<p>可以看到这个天气 Agent 主要功能就是：如果用户提问天气相关的内容，模型则调用上述工具获取天气。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Agent </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@mastra/core/agent&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> weatherTool </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;../tools/weather-tool&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> createAIModel </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@/lib/utils&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> weatherAgent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Agent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Weather Agent&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instructions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">You are a helpful weather assistant that provides accurate weather information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">Your primary function is to help users get weather details for specific locations. When responding:</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Always ask for a location if none is provided</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- If the location name isn’t in English, please translate it</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Include relevant details like humidity, wind conditions, and precipitation</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">- Keep responses concise but informative</span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token template-string string" style="color:#e3116c">Use the weatherTool to fetch current weather data.</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createAIModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;gpt-4o-mini-0718&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tools</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> weatherTool </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>模型使用的 Vercel AI SDK，如果你是用的 OpenAI 或者 Claude 等模型，可以直接使用 @ai-sdk/openai 这些包。如果你和我一样，使用的服务商统一包装的兼容 OpenAI 的接口，则可以这样：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> createOpenAICompatible </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@ai-sdk/openai-compatible&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">createAIModel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">modelName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createOpenAICompatible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;custom model&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseURL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://your-base-url/api/openai/v1/&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// api key 最好配置到 .env 文件中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;your-api-key&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">modelName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后我们建一个 agent 的入口文件 <code>mastra/index.ts</code>：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Mastra </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@mastra/core&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> PinoLogger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@mastra/loggers&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LibSQLStore </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@mastra/libsql&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> weatherAgent </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./agents/weather-agent&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mastra </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Mastra</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> weatherAgent </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LibSQLStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// stores telemetry, evals, ... into memory storage, if it needs to persist, change to file:../mastra.db</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;:memory:&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PinoLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Mastra&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    level</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;info&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="5">
<li>一个简单的 Agent 就完成了，我们开发一个接口测试一下：</li>
</ol>
<p>在 app 目录下新建 <code>/(chat)/api/chat/route.ts</code>：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mastra </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@/lib/mastra&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> NextResponse </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;next/server&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> city </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> agent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mastra</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getAgent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;weatherAgent&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> agent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">What&#x27;s the weather like in </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">city</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">?</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toDataStreamResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>使用 Postman 访问 <a href="http://localhost:3000/api/talk" target="_blank" rel="noopener noreferrer">http://localhost:3000/api/talk</a> 接口测试一下：</li>
</ol>
<p><strong>流式返回了天气信息！！</strong></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">f</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;messageId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;msg-xZkgBuDjmIEtRWqu0wB6kNFw&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">9</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;toolCallId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;call_iQt37jB3orK3HhY0ZGBWUClB&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;toolName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;weatherTool&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;args&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;location&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;New York&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;toolCallId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;call_iQt37jB3orK3HhY0ZGBWUClB&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;result&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;temperature&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;feelsLike&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;humidity&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">88</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;windSpeed&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">13.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;windGust&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">36.7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;conditions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Overcast&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;location&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;New York&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;finishReason&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;tool-calls&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;usage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;promptTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">99</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;completionTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;isContinued&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;messageId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;msg-Bhwx7fT1X0zQTxBnKAeb00xi&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;The&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; current&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; weather&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; in&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; New&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; York&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; is&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; as&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; follows&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; **&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Temperature&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:**&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;9&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;°C&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; (&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Feels&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; like&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;6&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;°C&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;)\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; **&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Humidity&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:**&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;88&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;%\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; **&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Wind&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; Speed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:**&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;13&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; km&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; **&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Wind&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; Gust&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:**&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;36&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; km&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; **&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Conditions&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;:**&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; Over&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;cast&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;If&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; you&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; need&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; more&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; details&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; or&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; information&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; about&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; another&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; location&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; feel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; free&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; to&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; ask&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;finishReason&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;stop&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;usage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;promptTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">145</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;completionTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">88</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;isContinued&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;finishReason&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;stop&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;usage&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;promptTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">244</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;completionTokens&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">92</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="7">
<li>如果有更复杂的需求，可以尝试 Workflow ，使用不同的模型处理多个任务，最终组合称为一个更好的 Agent。这里就不展开了。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="写在后面">写在后面<a href="#写在后面" class="hash-link" aria-label="写在后面的直接链接" title="写在后面的直接链接">​</a></h2>
<p>很欣喜能看到一个 TS 的 Agent 框架，而且从文档代码来看，完成度和质量都很高。</p>
<p>但我们应该意识到，除了 Agent 开发工具，更重要的是找到<strong>合适的落地场景</strong>。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-30-deepwiki.md">DeepWiki - 阅读开源代码的神器</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-30T00:00:00.000Z">2025年4月30日</time> · <!-- -->阅读需 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/04/29/1745915063123-0603daf0-f9b8-42af-9597-59570e3a7eae.png" alt="" class="img_ev3q"></p>
<p>以后推荐开源项目：
❌ <a href="https://github.com/xx/yy" target="_blank" rel="noopener noreferrer">https://github.com/xx/yy</a>
✅ <a href="https://deepwiki.com/xx/yy" target="_blank" rel="noopener noreferrer">https://deepwiki.com/xx/yy</a></p>
<hr>
<p>Devin （就是那个每月 500 刀的 AI 程序员）团队推出了 DeepWiki（<a href="https://deepwiki.org/%EF%BC%89%EF%BC%8C%E4%BB%8E%E6%AD%A4%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81%E6%9B%B4%E6%96%B9%E4%BE%BF%E4%BA%86%E3%80%82" target="_blank" rel="noopener noreferrer">https://deepwiki.org/），从此阅读源码更方便了。</a></p>
<p>只需要将开源项目链接的 github.com 替换为 deepwiki.com，就可以得到一份详尽的项目文档，比如：<a href="https://deepwiki.com/vercel/ai-chatbot%E3%80%82" target="_blank" rel="noopener noreferrer">https://deepwiki.com/vercel/ai-chatbot。</a></p>
<p>（比源文档详细的多：<a href="https://chat-sdk.dev/docs/getting-started/overview%EF%BC%89" target="_blank" rel="noopener noreferrer">https://chat-sdk.dev/docs/getting-started/overview）</a></p>
<p>甚至文档内还有图表：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img15@main/2025/04/29/1745915703384-ecf58d95-9a66-4f07-ab5e-55419797e20d.png" alt="" class="img_ev3q"></p>
<p>并且可以基于文档进行问答：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img8@main/2025/04/29/1745915759075-d06bf6c0-3266-4d8d-ad7d-ab2aa7c0eba8.png" alt="" class="img_ev3q"></p>
<p>快去试试吧！</p>
<p>最后祝大家五一假期快乐！</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-24-google-promtps-2.md">谷歌提示词工程 - 最佳实践</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-24T00:00:00.000Z">2025年4月24日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>接上文<a href="/blog/2025-04-23-google-promtps.md">谷歌提示词工程 - 模型原理和提示词技术</a>，讨论提示词的最佳实践。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img6@main/2025/04/23/1745392049583-b2db7b1e-2f2b-4565-8252-14f946e00719.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="提供示例">提供示例<a href="#提供示例" class="hash-link" aria-label="提供示例的直接链接" title="提供示例的直接链接">​</a></h3>
<p>正如上文提示词技术提到的单样本、少样本那样，在提示中提供样例十分重要。这样模型就能在示例的参考下输出更加准确的内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="简约设计">简约设计<a href="#简约设计" class="hash-link" aria-label="简约设计的直接链接" title="简约设计的直接链接">​</a></h3>
<p>基本原则是：若你自己都觉得困惑，模型很可能也会困惑。避免使用复杂语言，且不要提供无关信息。</p>
<p>尝试使用描述动作的动词。以下是一组示例：</p>
<blockquote>
<p>行动、分析、归类、分类、对比、比较、创造、描述、定义、评估、提取、发现、生成、识别、列举、测量、组织、解析、挑选、预测、提供、排序、推荐、返回、检索、改写、选择、展示、整理、总结、翻译、撰写。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="明确提出需求">明确提出需求<a href="#明确提出需求" class="hash-link" aria-label="明确提出需求的直接链接" title="明确提出需求的直接链接">​</a></h3>
<p>详细说明期望输出。简短的指令可能无法充分引导大语言模型，或过于笼统。在提示中提供具体细节（通过系统或上下文提示）有助于模型聚焦相关内容，提高整体准确性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="优先使用指令而非约束">优先使用指令而非约束<a href="#优先使用指令而非约束" class="hash-link" aria-label="优先使用指令而非约束的直接链接" title="优先使用指令而非约束的直接链接">​</a></h3>
<p>提示中使用的指令和约束用于引 导大语言模型的输出。</p>
<p>尽可能使用正向指令：用“应该做什么”替代“禁止做什么”，这能避免混淆并提高输出准确性。</p>
<p>约束条件在特定场景仍具价值：当需要防止模型生成有害/偏见内容，或要求严格输出格式时。</p>
<p>作为最佳实践，应优先处理指令，明确说明您希望模型执行的操作，仅在出于安全性、清晰度或特定需求时使用约束条件。通过实验与迭代测试不同指令和约束的组合，以找到最适合您特定任务的方案，并予以记录。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="控制最大令牌长度">控制最大令牌长度<a href="#控制最大令牌长度" class="hash-link" aria-label="控制最大令牌长度的直接链接" title="控制最大令牌长度的直接链接">​</a></h3>
<p>要控制生成式大语言模型(LLM)的响应长度，您可以在配置中设置最大令牌限制，或在提示词中明确指定所需长度。例如：</p>
<blockquote>
<p>&quot;Explain quantum physics in a tweet length message.&quot;</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="在提示词中使用变量">在提示词中使用变量<a href="#在提示词中使用变量" class="hash-link" aria-label="在提示词中使用变量的直接链接" title="在提示词中使用变量的直接链接">​</a></h3>
<p>为了实现提示词复用并增强动态性，可在提示词中使用变量，这些变量可根据不同输入进行替换。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img18@main/2025/04/23/1745397189984-9bd0b762-1421-404a-bbbf-2636a357c048.png" alt="" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="尝试不同的输入格式与写作风格">尝试不同的输入格式与写作风格<a href="#尝试不同的输入格式与写作风格" class="hash-link" aria-label="尝试不同的输入格式与写作风格的直接链接" title="尝试不同的输入格式与写作风格的直接链接">​</a></h3>
<p>不同模型、配置、提示格式、措辞和提交方式会产生不同结果。因此需对提示属性进行实验，如风格、措辞及提示类型（零样本、少样本、系统提示） 。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分类任务的小样本提示中需混合不同类别">分类任务的小样本提示中，需混合不同类别<a href="#分类任务的小样本提示中需混合不同类别" class="hash-link" aria-label="分类任务的小样本提示中，需混合不同类别的直接链接" title="分类任务的小样本提示中，需混合不同类别的直接链接">​</a></h3>
<p>一般而言，小样本示例的顺序影响不大。但在执行分类任务时，务必在少量示例中混合可能的响应类别。这是因为固定顺序可能导致模型对示例顺序产生过拟合。通过混合响应类别，可确保模型学会识别各类别的关键特征，而非简单记忆示例顺序。这种方法能提升模型在未见数据上的鲁棒性和泛化性能。</p>
<p>经验法则建议从6个少量示例开始，并由此测试准确度。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="适应模型更新">适应模型更新<a href="#适应模型更新" class="hash-link" aria-label="适应模型更新的直接链接" title="适应模型更新的直接链接">​</a></h3>
<p>紧跟模型更新，尝试新版模型调整提示词充分利用新特性。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="尝试不同输出格式">尝试不同输出格式<a href="#尝试不同输出格式" class="hash-link" aria-label="尝试不同输出格式的直接链接" title="尝试不同输出格式的直接链接">​</a></h3>
<p>除输入格式外，还可探索输出格式。对于数据提取、筛选、解析、排序、分级或分类等非创造性任务，建议采用JSON或XML等结构化格式返回结果。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="json-修复">JSON 修 复<a href="#json-修复" class="hash-link" aria-label="JSON 修复的直接链接" title="JSON 修复的直接链接">​</a></h3>
<p>JSON 格式校验严格，可以使用 PyPI 的 json-repair 智能修复 JSON 格式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-schema">使用 Schema<a href="#使用-schema" class="hash-link" aria-label="使用 Schema的直接链接" title="使用 Schema的直接链接">​</a></h3>
<p>输入数据也可以使用 JSON 格式高效的组织数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="与其他提示工程师协同实验">与其他提示工程师协同实验<a href="#与其他提示工程师协同实验" class="hash-link" aria-label="与其他提示工程师协同实验的直接链接" title="与其他提示工程师协同实验的直接链接">​</a></h3>
<p>当每个人都遵循本章所述的最佳实践时，您将观察到不同提示方案间的性能差异。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="思维链最佳实践">思维链最佳实践<a href="#思维链最佳实践" class="hash-link" aria-label="思维链最佳实践的直接链接" title="思维链最佳实践的直接链接">​</a></h3>
<p>进行思维链提示时，必须将答案置于推理过程之后，因为推理过程的生成会改变模型预测最终答案时所获得的标记（token）。</p>
<p>使用思维链与自洽性方法时，需确保能从提示中分离出最终答案，使其独立于推理过程。</p>
<p>思维链提示的温度参数应设为0。</p>
<p>思维链提示基于贪婪解码机制，即语言模型根据概率最高中的下一个词。一般而言，当涉及推理得出最终答案时，通常存在唯一正确答案，因此温度参数应始终设置为0。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="记录不同提示尝试方案">记录不同提示尝试方案<a href="#记录不同提示尝试方案" class="hash-link" aria-label="记录不同提示尝试方案的直接链接" title="记录不同提示 尝试方案的直接链接">​</a></h3>
<p>细记录每次提示尝试的完整细节，这样才能逐步总结出哪些方法有效，哪些无效。</p>
<p>提示工程是一个迭代过程。设计并测试不同提示方案，分析记录结果，根据模型表现优化提示词。持续实验直至获得理想输出。当更换模型或调整模型配置时，需重新用先前提示词进行实验验证。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img18@main/2025/04/23/1745397833321-0027f4c9-b523-4ff8-8f3b-724c8d363e88.png" alt="" class="img_ev3q"></p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-23-google-promtps.md">谷歌提示词工程 - 模型原理和提示词技术</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-23T00:00:00.000Z">2025年4月23日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 /   开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img6@main/2025/04/23/1745392049583-b2db7b1e-2f2b-4565-8252-14f946e00719.png" alt="" class="img_ev3q"></p>
<p>谷歌前段时间发布了提示词工程白皮书，已经有很多博主推荐了，最近终于有时间阅读一下。以下是笔记记录。</p>
<p>原文：<a href="https://drive.google.com/file/d/1AbaBYbEa_EbPelsT40-vj64L-2IwUJHy/view?pli=1" target="_blank" rel="noopener noreferrer">https://drive.google.com/file/d/1AbaBYbEa_EbPelsT40-vj64L-2IwUJHy/view?pli=1</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模型工作原理">模型工作原理<a href="#模型工作原理" class="hash-link" aria-label="模型工作原理的直接链接" title="模型工作原理的直接链接">​</a></h3>
<p>大语言模型的本质是<strong>预测</strong>。模型接受输入文本，根据训练数据循环预测后续的文本。提示词就是在引导模型正确的预测。</p>
<p>另外需要了解模型的输出配置，如果你调用过大模型的 API 应该对这些参数比较熟悉。</p>
<p><strong>Output length</strong>：输出长度限制对于大模型的性能，响应时间尤为重要。</p>
<p><strong>Sampling controls</strong>：控制预测结果</p>
<p>Temperature，越高则输出结果越发散，越低则结果更具有确定性。top-K 和 top-P 和 Temperature 类似，值越高，则输出结果越具有创造性和多样性。越高。</p>
<p>文档中给出了几个场景的配置样例：</p>
<ol>
<li>Temperature 值 0.2、top-P 值 0.95 和 top-K 值 30 的组合能产生相对连贯且适度创新的结果。</li>
<li>若追求更高创造性，可 Temperature 值 0.9、top-P 值 0.99 和 top-K 值40 的配置。</li>
<li>如需更保守的输出，建议采用 Temperature 值 0.1、top-P 值0.9 和 top-K值 20 的参数。</li>
<li> 对于存在唯一正确答案的任务（如数学题求解） ，应将 Temperature 值设为 0。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="提示词技术">提示词技术<a href="#提示词技术" class="hash-link" aria-label="提示词技术的直接链接" title="提示词技术的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="零样本zero-shot">零样本（zero shot）<a href="#零样本zero-shot" class="hash-link" aria-label="零样本（zero shot）的直接链接" title="零样本（zero shot）的直接链接">​</a></h4>
<p>零样本仅提供任务描述和供大语言模型处理的文本。不过可以通过增加单个示例（<strong>单样本</strong>）或者多个示例（<strong>少样本</strong>）让模型输出更符合要求的内容。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="系统提示system-prompting">系统提示（System Prompting）<a href="#系统提示system-prompting" class="hash-link" aria-label="系统提示（System Prompting）的直接链接" title="系统提示（System Prompting）的直接链接">​</a></h4>
<p>系统提示设定语言模型的整体语境和目的，明确模型应执行的宏观任务，如语言翻译、评论分类等。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="角色提示role-prompting">角色提示（Role prompting）<a href="#角色提示role-prompting" class="hash-link" aria-label="角色提示（Role prompting）的直接链接" title="角色提示（Role prompting）的直接链接">​</a></h4>
<p>给模型分配特根据定角色，使模型能角色定位生成更相关、信息量更大的输出。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="情境提示contextual-prompting">情境提示（Contextual prompting）<a href="#情境提示contextual-prompting" class="hash-link" aria-label="情境提示（Contextual prompting）的直接链接" title="情境提示（Contextual prompting）的直接链接">​</a></h4>
<p>给模型提供上下文提示 ，比如：</p>
<blockquote>
<p>背景：您正在为一家关于80年代复古街机游戏的博客撰稿。请建议3个文章主题，并附上简要说明每篇文章应包含的内容。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="回退式提示step-back-prompting">回退式提示（Step-back prompting）<a href="#回退式提示step-back-prompting" class="hash-link" aria-label="回退式提示（Step-back prompting）的直接链接" title="回退式提示（Step-back prompting）的直接链接">​</a></h4>
<p>回退式提示法是一种通过让大语言模型先思考与当前具体任务相关的宏观问题，再将宏观问题的答案作为后续具体任务提示的输入，从而提升模型表现的技术。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="思维链chain-of-thoughtcot">思维链（Chain of Thought，CoT）<a href="#思维链chain-of-thoughtcot" class="hash-link" aria-label="思维链（Chain of Thought，CoT）的直接链接" title="思维链（Chain of Thought，CoT）的直接链接">​</a></h4>
<p>思维链一种通过生成中间推理步骤来提升大语言模型推理能力的技术。思维链特别适合代码生成时，分解需求逐步输出代码的过程。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="思维树tree-of-thoughtstot">思维树（Tree of Thoughts，ToT）<a href="#思维树tree-of-thoughtstot" class="hash-link" aria-label="思维树（Tree of Thoughts，ToT）的直接链接" title="思维树（Tree of Thoughts，ToT）的直接链接">​</a></h4>
<p>思维树允许大语言模型同时探索多条不同的推理路径，而非仅遵循单一线性思维链。适合探索复杂任务。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="推理与行动reactreason--act">推理与行动（ReAct，reason &amp; act）<a href="#推理与行动reactreason--act" class="hash-link" aria-label="推理与行动（ReAct，reason &amp; act）的直接链接" title="推理与行动（ReAct，reason &amp; act）的直接链接">​</a></h4>
<p>大模型基于自然语言推理和外部工具（搜索、代码解释器等）来解决复杂任务。只是实现智能体（Agent）第一步。这部分需要有编写代码的能力，或者借助其他智能体构建工具。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="其他">其他<a href="#其他" class="hash-link" aria-label="其他的直接链接" title="其他的直接链接">​</a></h4>
<p>可以借助大模型优化提示词。</p>
<p>文档还专门提到了代码相关的提示，编写脚本、解释代码、调试、Review等等。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">AI</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-21-old-fe-1.md">盘点前端还在更新的老项目</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-21T00:00:00.000Z">2025年4月21日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱 好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>今天不聊 AI，聊点前端。冒着暴露年龄的风险聊点前端里还在更新的老项目。</p>
<p>（其实 React、Vue 这些库也算老项目了，不过不再我们讨论之列，主要讨论那些我们平时基本见不到但一直更新的项目）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jquery">jQuery<a href="#jquery" class="hash-link" aria-label="jQuery的直接链接" title="jQuery的直接链接">​</a></h3>
<p>jQuery 算是老项目里的代表里，他的 <code>$</code> 语法可以说是别具一格，在那个需要浏览器兼容的年代独树一帜。</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">ajax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/api/getWeather&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">zipcode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">97201</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token parameter">result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#weather-temp&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;strong&gt;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;/strong&gt; degrees&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> hiddenBox </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#banner-message&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#button-container button&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;click&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token parameter">event</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hiddenBox</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">show</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Github 上看了一下 2022 年就已经开始着手准备 4.0 版本了（<a href="https://github.com/jquery/jquery/milestone/7%EF%BC%89%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/jquery/jquery/milestone/7）。</a></p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img12@main/2025/04/21/1745215856167-0f66a243-84a9-4b9c-90ac-7ece5e2c38ad.png" alt="" class="img_ev3q"></p>
<p><a href="https://jquery.com/" target="_blank" rel="noopener noreferrer">官网</a>表示 4.0 版本即将发布了：</p>
<blockquote>
<p>jQuery 4.0 is coming soon! Prepare by upgrading to the latest jQuery 3.x release. Learn more about our version support.</p>
</blockquote>
<p>另一个与之相似的项目 <a href="https://zeptojs.com/" target="_blank" rel="noopener noreferrer">zepto.js</a> 不知道大家有没有听说过，作为当时在 mobile 项目上的替代品。目前看 Github 已经留在 6 年前了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gulp">Gulp<a href="#gulp" class="hash-link" aria-label="Gulp的直接链接" title="Gulp的直接链接">​</a></h3>
<p>在还没有 Webpack 的年代，<a href="https://gulpjs.com/" target="_blank" rel="noopener noreferrer">Gulp</a> 是我认为最好用的自动化构建工具了。流式或者并行的将构建任务串联起来，而且支持插件扩展。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img12@main/2025/04/21/1745216667840-037ba719-c87e-4de2-8baa-b86b07504351.png" alt="" class="img_ev3q"></p>
<p>去年 3 月（2024/3/29），<a href="https://medium.com/gulpjs/announcing-gulp-v5-c67d077dbdb7" target="_blank" rel="noopener noreferrer">Gulp 5 正式发布</a>。</p>
<blockquote>
<p>Gulp 5 的发布之路漫长，但我们终于来了！此版本凝聚了 60 多个项目四年的心血。团队一共解决了 200 多个问题和 Pull Request。🤯</p>
</blockquote>
<p>Gulp 之前还有一个类似的项目：<a href="https://gruntjs.com/" target="_blank" rel="noopener noreferrer">Grunt</a>，不过最后更新时间停留在了 2021 年。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fabricjs">fabric.js<a href="#fabricjs" class="hash-link" aria-label="fabric.js的直接链接" title="fabric.js的直接链接">​</a></h3>
<p><a href="https://fabricjs.com/docs/" target="_blank" rel="noopener noreferrer">fabric.js</a> 是一个 Canvas 2D 操作库，把操作 Canvas 变的和操作 JS Object 一样简单。</p>
<p>虽然很好用，但代码依然是 ES5 时代，代码库里很多 Object.prototype，还有一些 polyfill code。不过终于去年发布了 v6 大版本，支持了 TypeScript。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img9@main/2025/04/21/1745217332670-feb3786f-71d6-4a97-a8b4-58f82f690f41.png" alt="" class="img_ev3q"></p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> React</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> useEffect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> useRef </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;react&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> fabric </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;fabric&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// v6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> fabric </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;fabric&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// v5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">FabricJSCanvas</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> canvasEl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">useRef</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">HTMLCanvasElement</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> canvas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">fabric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Canvas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">canvasEl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// make the fabric.Canvas instance available to your app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">updateCanvasContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">canvas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">updateCanvasContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      canvas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dispose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">canvas width</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;300&quot;</span><span class="token plain"> height</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;300&quot;</span><span class="token plain"> ref</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">canvasEl</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我的 <a href="https://github.com/sleepy-zone/fabritor-web" target="_blank" rel="noopener noreferrer">fabritor</a> 就是基于 fabric.js 构建的，后面也计划升级到 6.0 版本。</p>
<hr>
<p>今天先更新到这里，你还知道哪些老项目已经在坚持更新？</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/frontend">frontend</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025-04-14-github-no-vistit.md">从 Github 不能访问想到的</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-14T00:00:00.000Z">2025年4月14日</time> · <!-- -->阅读需 3 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/u/131369648?v=4" alt="SleepyZone"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/sleepy-zone" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">SleepyZone</span></a></div><small class="authorTitle_nd0D" title="前端开发 / 开源爱好者">前端开发 / 开源爱好者</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>上周末中国未登录用户无法访问 Github，瞬间在社交媒体引起轩然大波。</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img7@main/2025/04/14/1744620520993-54adfc65-507b-439a-924b-a5e91ee9353d.png" alt="" class="img_ev3q"></p>
<p>有人玩梗😂：</p>
<p><img decoding="async" loading="lazy" src="https://fastly.jsdelivr.net/gh/bucketio/img12@main/2025/04/14/1744620550287-2096f2d6-3fbe-410b-aa43-c448dc927077.png" alt="" class="img_ev3q"></p>
<p>有人焦虑，虽然之前已经有地方无法正常访问 Github，但原因心知肚明。这次疑似 Github 主动屏蔽中国 IP，和 OpenAI 类似，不免让人怀疑，难道最近的大国博弈开始影响 Github？</p>
<p>有人表示问题不大，毕竟哪个程序员不用魔法上网？</p>
<p>有人开始想退路，是不是可以备份开源项目了，一旦无法访问，而又没有备份，想想就心痛。</p>
<p>不过最后 Github 发布公告是因为配置变更导致这个问题（<a href="https://www.githubstatus.com/incidents/jfvgcls9swln%EF%BC%89%EF%BC%9A" target="_blank" rel="noopener noreferrer">https://www.githubstatus.com/incidents/jfvgcls9swln）：</a></p>
<blockquote>
<p>由于配置变更造成了意外影响，未登录的用户从中国访问 GitHub.com 时暂时无法访问。已登录的用户仍可继续 访问。影响于 2025 年 4 月 12 日 20:01 UTC 开始。影响已于 2025 年 4 月 13 日 14:55 UTC 缓解。导致此影响的配置更改已被撤销，用户在尝试访问 GitHub.com 时应该不会再遇到问题。</p>
</blockquote>
<p>（不得不感慨老外是松弛，搁国内 p0 故障加 325 起步😭）</p>
<hr>
<p>事情就是这么个事情，看起来像一场闹剧，国内开发者讨论了半天猜了半天，最后以一个公告结束。</p>
<p>其实我想说的是，国内的开发者过的确实太苦了。</p>
<p>想获得信息，全是英文文档，虽然现在 AI 大大降低了阅读的门槛。</p>
<p>而 AI ，像  OpenAI、Anthropic 都是主动屏蔽中国 IP 的，所以需要掌握一定的上网技巧，躲避两边的网络限制。</p>
<p>而现在内外的环境又充满了不确定性。不论是打工还是独立开发都是困难重重。</p>
<p>所以 Github 一点点的网络波动就影响了千千万万的国内开发者。</p>
<p>就目前来看，也很难寄希望于国内能出现 Github 同级别的服务，出现了大概率也会有很多奇奇怪怪的骚操作。</p>
<p>以上。</p>
<hr>
<div align="center"><p>欢迎关注我的公众号：前端生存指南，一起聊聊前端、AI 和生活。</p><img src="https://cloud-minapp-47803.cloud.ifanrusercontent.com/1tvAM68Cvrx3bfLR.jpg" style="width:180px"></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/talk">talk</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div></div>
</body>
</html>